[
    {
        "id": "bba8d161678c81a7",
        "type": "subflow",
        "name": "Subflow 2",
        "info": "",
        "in": [
            {
                "x": 560,
                "y": 200,
                "wires": [
                    {
                        "id": "f927bc80b83cf0b5"
                    }
                ]
            }
        ],
        "out": []
    },
    {
        "id": "f927bc80b83cf0b5",
        "type": "function",
        "z": "bba8d161678c81a7",
        "g": "ae39c6a66c76c1f7",
        "name": "GET schedule value",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet property_references = [];\n\nfunction getSchedulePresentValue() {\n  node.warn(\"Updating AVschedule...\");\n  for (let room in rooms) {\n    if (rooms[room].isActive) {\n      let temp = '{ \"type\": \"Schedule\", \"instance\": ' + rooms[room].scheduleID + ', \"property\": \"presentValue\"}';\n      property_references.push(JSON.parse(temp));\n    }\n  }\n  node.send({\n    method: \"POST\",\n    url: `https://${icalToScheduleConf.controllerIPAddress}/api/rest/v2/services/bacnet/local/objects/read-property-multiple`,\n    headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n    payload: {\n      \"encode\": \"text\",\n      \"property-references\": property_references\n    },\n    icalToScheduleConf: icalToScheduleConf,\n    rooms: rooms\n  });\n}\n\nsetTimeout(() => {\n  getSchedulePresentValue();\n  setInterval(getSchedulePresentValue, icalToScheduleConf.timeBetweenScheduleAVUpdate * 1000);\n}, 3000);\n\n\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 740,
        "y": 200,
        "wires": [
            [
                "f27d4d9f547f63d2"
            ]
        ]
    },
    {
        "id": "f27d4d9f547f63d2",
        "type": "http request",
        "z": "bba8d161678c81a7",
        "g": "ae39c6a66c76c1f7",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "2418490b3512393e",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 930,
        "y": 200,
        "wires": [
            [
                "737b63aad347dfbb",
                "c4da32cc46331895"
            ]
        ]
    },
    {
        "id": "737b63aad347dfbb",
        "type": "function",
        "z": "bba8d161678c81a7",
        "g": "ae39c6a66c76c1f7",
        "name": "WRITE Analog Values",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet property_references = [];\nlet results = msg.payload.results;\nlet setpoint;\n\n\nfor (let i = 0; i < results.length; i++) {\n  setpoint = results[i].value;\n  if (!setpoint || setpoint.includes(\"Null\")) {\n    node.warn(`Schedule ${results[i].instance} returns 0 or NULL`);\n  } else if (setpoint.includes(\"Unknown Object\")){\n    node.warn(`Schedule ${results[i].instance} doesn't exist`);\n  }else{\n  let temp = '{ \"type\": \"analogValue\", \"instance\": ' + (icalToScheduleConf.scheduleAVInstanceOffset + results[i].instance) + ', \"property\": \"presentValue\", \"value\": ' + setpoint + ' }';\n  property_references.push(JSON.parse(temp));\n  }\n}\n\n\nreturn {\n  method: \"POST\",\n  url: `https://${icalToScheduleConf.controllerIPAddress}/api/rest/v2/services/bacnet/local/objects/write-property-multiple`,\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    \"encode\": \"text\",\n    \"property-references\": property_references\n  }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1120,
        "y": 200,
        "wires": [
            [
                "b9652aa7e37ee774"
            ]
        ]
    },
    {
        "id": "b9652aa7e37ee774",
        "type": "http request",
        "z": "bba8d161678c81a7",
        "g": "ae39c6a66c76c1f7",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "2418490b3512393e",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1310,
        "y": 200,
        "wires": [
            [
                "c6b9ddc5528b6152"
            ]
        ]
    },
    {
        "id": "c6b9ddc5528b6152",
        "type": "debug",
        "z": "bba8d161678c81a7",
        "g": "ae39c6a66c76c1f7",
        "name": "debug 7",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1460,
        "y": 200,
        "wires": []
    },
    {
        "id": "c4da32cc46331895",
        "type": "debug",
        "z": "bba8d161678c81a7",
        "g": "ae39c6a66c76c1f7",
        "name": "debug 6",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1080,
        "y": 160,
        "wires": []
    },
    {
        "id": "ae39c6a66c76c1f7",
        "type": "group",
        "z": "bba8d161678c81a7",
        "name": "Link schedules and  scheduleAV",
        "style": {
            "fill": "#ffbfbf",
            "label": true,
            "color": "#000000",
            "stroke": "#ffC000"
        },
        "nodes": [
            "f927bc80b83cf0b5",
            "f27d4d9f547f63d2",
            "737b63aad347dfbb",
            "b9652aa7e37ee774",
            "c6b9ddc5528b6152",
            "c4da32cc46331895"
        ],
        "x": 614,
        "y": 119,
        "w": 952,
        "h": 122
    },
    {
        "id": "4e1ab562e956dc8c",
        "type": "subflow",
        "name": "Creates Events",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 100,
                "y": 220,
                "wires": [
                    {
                        "id": "8c1ae40951ecd894"
                    }
                ]
            }
        ],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "8c1ae40951ecd894",
        "type": "function",
        "z": "4e1ab562e956dc8c",
        "g": "fe7fb58eb39138e2",
        "name": "Rooms",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\nlet nbActiveRooms = rooms.filter(element => element.isActive === true).length;\n\nfunction createEvent() {\n    icalToScheduleConf.nbActiveRooms = nbActiveRooms;\n    icalToScheduleConf.startTimeUpdateSchedule = Date.now();\n    icalToScheduleConf.roomCounter = 0;\n\n    flow.set('sf_icalToScheduleConf', icalToScheduleConf);\n    for (let j = 0; j < rooms.length; j++) {\n        if (rooms[j].isActive) {\n            node.send({\n                action: \"queue\",\n                payload: rooms[j]\n            });\n        }\n    }\n}\n\ncreateEvent();\nsetInterval(createEvent, icalToScheduleConf.timeBetweenScheduleUpdate * 1000); \n\n\n\n\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 240,
        "y": 220,
        "wires": [
            [
                "27631b666e3b7a80"
            ]
        ],
        "icon": "node-red/parser-json.svg"
    },
    {
        "id": "290efeb1f3a9dd51",
        "type": "function",
        "z": "4e1ab562e956dc8c",
        "g": "fe7fb58eb39138e2",
        "name": "All rooms process time",
        "func": "let roomInfo = msg.roomInfo;\nlet msgCorrect = false;\n\nlet icalToScheduleConf = flow.get('sf_icalToScheduleConf');\n\n\nswitch (msg.statusCode) {\n    case 200:\n        msgCorrect = true;\n        break;\n    case 400:\n        node.error(\"Error 400: Bad HTTP Request\");\n        if (msg.payload.includes(\"write-access-denied\")) {\n            node.error(\"Error: Trying to write a Read Only object (analogInput)\");\n        }\n        break;\n    case 401:\n        node.error(\"Error 401: Can't connect to controller: Authorization error\");\n        break;\n    case 500:\n        node.error(\"Error 500: Server Error 500\");\n        break;\n    case 404:\n        node.error(`Error 404 : Schedule ${msg.roomConf.scheduleName} doesn't exist `);\n        break;\n    case \"ETIMEDOUT\":\n        node.error(\"Error: Can't connect to controller: TimeOut\");\n        break;\n    case 501:\n        node.error(\"Error 501. Not recognized request methode. Server not capable of supporting it for any resource\")\n        break;\n    case \"ENOTFOUND\":\n        node.error(\"RequestError: no url found. Please correct the url\")\n}\n\n\nicalToScheduleConf.roomCounter++;\n//node.warn(\"Room counter : \" +  icalToScheduleConf.roomCounter);\n//node.warn(\"NB Room : \" +  icalToScheduleConf.nbActiveRooms);\nif(icalToScheduleConf.roomCounter % icalToScheduleConf.nbActiveRooms == 0){\n    node.warn(`${icalToScheduleConf.nbActiveRooms} rooms processed in ${(Date.now() - icalToScheduleConf.startTimeUpdateSchedule) / 1000} s`);\n    node.status({ fill: \"green\", shape: \"dot\", text: `Process time : ${(Date.now() - icalToScheduleConf.startTimeUpdateSchedule) / 1000} s`});\n    icalToScheduleConf.startTimeUpdateSchedule =  Date.now();\n}\n\nflow.set('sf_icalToScheduleConf',icalToScheduleConf);\n\nmsg.action = \"unqueue\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "//flow.set('f_isControllerReady', true);\n",
        "finalize": "",
        "libs": [],
        "x": 1180,
        "y": 220,
        "wires": [
            [
                "27631b666e3b7a80"
            ]
        ]
    },
    {
        "id": "27631b666e3b7a80",
        "type": "function",
        "z": "4e1ab562e956dc8c",
        "g": "fe7fb58eb39138e2",
        "name": "Room Queue",
        "func": "let roomsQueue = flow.get('f_roomsQueue');\nconst maxQueueSize = 150;\n\n\nnode.status({ fill: \"green\", shape: \"dot\", text: `Queue size : ${roomsQueue.length} ` });\n\n////////////////// Queue ////////////////\nif (msg.action === \"queue\") {\n    if (roomsQueue.length > maxQueueSize) {\n        node.status({ fill: \"red\", shape: \"dot\", text: `Queue overflow (max : ${maxQueueSize})} ` });\n        node.error(`Room queue has exeeded its maximum size ${maxQueueSize}`);\n    }\n    else if (roomsQueue.length == 0 && flow.get('f_initialStart')) {\n        // First message, no need to queue.\n        flow.set('f_initialStart', false);\n        node.warn(\"Creating events for each room...\");\n        return {\n            \"url\": msg.payload.url,\n            \"timezone\": msg.payload.timeZone,\n            \"preview\": msg.payload.nbrDaysPreview,\n            \"roomConf\": msg.payload\n\n        }\n    }\n    else {\n        //node.warn(\"Other message, Queue\");\n        roomsQueue.push(msg.payload);\n        flow.set('f_roomsQueue', roomsQueue);\n    }\n}\n\n////////////////// Unqueue ////////////////\nelse if (msg.action === \"unqueue\") {\n    if (roomsQueue.length === 0) {\n        flow.set('f_initialStart', true);\n        //node.warn(\"Unqueue with lenght == 0, initialStart = true\");\n    }\n    else {\n        let newRoom = roomsQueue.shift();\n        flow.set('f_roomsQueue', roomsQueue);\n        //node.warn(\"Unqueue\");\n        return {\n            \"url\": newRoom.url,\n            \"timezone\": newRoom.timeZone,\n            \"preview\": msg.payload.nbrDaysPreview,\n            \"roomConf\": newRoom\n        }\n    }\n}\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "let roomsQueue = [];\nflow.set('f_roomsQueue', roomsQueue);\n\nlet initialStart = true;\nflow.set('f_initialStart', initialStart);\n",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 220,
        "wires": [
            [
                "d6d4a4374e833798"
            ]
        ]
    },
    {
        "id": "e62d8deddfbe7df0",
        "type": "http request",
        "z": "4e1ab562e956dc8c",
        "g": "fe7fb58eb39138e2",
        "name": "HTTP",
        "method": "use",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "b5c6e6a3dffe1547",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 990,
        "y": 220,
        "wires": [
            [
                "290efeb1f3a9dd51"
            ]
        ]
    },
    {
        "id": "d6d4a4374e833798",
        "type": "ical-upcoming",
        "z": "4e1ab562e956dc8c",
        "g": "fe7fb58eb39138e2",
        "confignode": "43e2580ec630c632",
        "timeout": "",
        "timeoutUnits": "seconds",
        "cron": "",
        "name": "Get Room calendar",
        "offsettype": "",
        "offset": "",
        "offsetUnitstype": "",
        "offsetUnits": "",
        "eventtypes": "events",
        "eventtypestype": "eventtypes",
        "calendar": "",
        "calendartype": "str",
        "triggertype": "trigger",
        "trigger": "always",
        "timezone": "",
        "timezonetype": "str",
        "dateformat": "{ \"timeStyle\": \"short\", \"dateStyle\": \"short\" }",
        "dateformattype": "json",
        "language": "en",
        "languagetype": "language",
        "filterProperty": "summary",
        "filterPropertytype": "filterProperty",
        "filterOperator": "between",
        "filterOperatortype": "filterOperator",
        "filtertype": "str",
        "filter2type": "str",
        "filter2": "",
        "filter": "",
        "checkall": false,
        "endpreview": "",
        "endpreviewUnits": "",
        "previewtype": "num",
        "preview": "",
        "previewUnitstype": "previewUnits",
        "previewUnits": "days",
        "pastviewtype": "num",
        "pastview": "0",
        "pastviewUnits": "days",
        "pastviewUnitstype": "pastviewUnits",
        "x": 610,
        "y": 220,
        "wires": [
            [
                "2036442de614c0be"
            ]
        ]
    },
    {
        "id": "2036442de614c0be",
        "type": "function",
        "z": "4e1ab562e956dc8c",
        "g": "fe7fb58eb39138e2",
        "name": "Create events",
        "func": "let icalToScheduleConf = flow.get('sf_icalToScheduleConf');\nlet roomConf = msg.roomConf;\nlet eventNumber = msg.total;\nlet events = [/* {eventStart : Date , eventEnd : Date,, ...}*/];  // List of events to create.\nlet httpRequestEventList = {};\n\n///////////////////////////////////////////////////////////////////////\n/////////////////     Events manipulation  ////////////////////////////\n///////////////////////////////////////////////////////////////////////\nfor (let i = 0; i < eventNumber; i++) {\n\n  // Event are discarded according to their \"event description\" in the ics file.\n  if (!icalToScheduleConf.eventsToDiscard.some(discardStr => msg.payload[i].description?.includes(discardStr))) {\n\n    //////////  groupEvents == true   //////////////\n    if (icalToScheduleConf.groupEvents) {\n      let msgEventStart = new Date(msg.payload[i].eventStart);\n      let msgEventEnd = new Date(msg.payload[i].eventEnd);\n\n      // Check if an event with same year-date-time already exist in events[].\n      const idx = events.findIndex(evt => {\n        return (\n          msgEventStart.getDate() === evt.eventStart.getDate() &&\n          msgEventEnd.getMonth() === evt.eventStart.getMonth() &&\n          msgEventEnd.getFullYear() === evt.eventStart.getFullYear()\n        );\n      });\n\n      if (idx != -1) {    // Event with same year-date-time already exits\n\n        if (msgEventStart < events[idx].eventStart) events[idx].eventStart = msgEventStart; // Update start time\n        if (msgEventEnd > events[idx].eventEnd) events[idx].eventEnd = msgEventEnd;         // Update end time\n        //node.warn(\"idx : \" + idx);\n        //node.warn(events);\n      }\n      else {               // Add a new event\n        //node.warn(\"Event added\");\n        events.push(msg.payload[i]);\n        events.at(-1).eventStart = new Date(events.at(-1).eventStart);  // at(-1) = last index\n        events.at(-1).eventEnd = new Date(events.at(-1).eventEnd);      // at(-1) = last index\n        events.at(-1).summary = \"Merged Events\";\n        //node.warn(events);\n      }\n    }\n\n    //////////  groupEvents == false   //////////////\n    else {\n      //node.warn(\"Event added\");\n      events.push(msg.payload[i]);\n      events.at(-1).eventStart = new Date(events.at(-1).eventStart);  // at(-1) = last index\n      events.at(-1).eventEnd = new Date(events.at(-1).eventEnd);      // at(-1) = last index\n    }\n  }\n  else {\n    //node.warn(`Event ${i} : ${msg.payload[i].summary} is discarded`);\n  }\n}\n\n// node.warn(events);\n\n\n///////////////////////////////////////////////////////////////////////\n/////////////////    HTTP Request Creation   //////////////////////////\n///////////////////////////////////////////////////////////////////////\nlet eventID = 1;\n\nfor (let i = 0; i < events.length; i++) {\n\n  let start = new Date(events[i].eventStart);\n  let end = new Date(events[i].eventEnd);\n\n  // Rule 1 : discard events shorter than 30 minutes\n  const durationMinutes = (end.getTime() - start.getTime()) / (1000 * 60);\n  if (durationMinutes < icalToScheduleConf.minimumSlotDuration) {\n    node.warn(`Event ${i} \"${events[i].summary}\" discarded (duration < ${icalToScheduleConf.minimumSlotDuration} min).`);\n    continue;\n  }\n\n  // Adjust the time with timeOffsetBeforeStart and timeOffsetBeforeEnd\n  if (icalToScheduleConf.groupEvents) {\n    const midnight = new Date(start);\n    midnight.setHours(0, 0, 0, 0);\n\n    start.setMinutes(start.getMinutes() - roomConf.timeOffsetBeforeStart);\n    end.setMinutes(end.getMinutes() - roomConf.timeOffsetBeforeEnd);\n\n    // Rule 2 : Clamp start to midnight if it went before 00:00\n    if (start < midnight) {\n      start = new Date(midnight);\n      node.warn(`Event ${i} \"${events[i].summary}\" clamp to midnight.`);\n    }\n\n    // Rule 3 : ensure start < end.\n    if (start >= end) {\n      node.warn(`Event ${i} \"${events[i].summary}\" discarded  (start >= end).`);\n      continue;\n    }\n  }\n\n\n  // Create Event request\n  let eventObject = {\n    [eventID]: {\n      \"event-priority\": 16,\n      period: {\n        date: {\n          month: start.getMonth() + 1,\n          year: start.getFullYear(),\n          \"day-of-month\": start.getDate()\n        },\n        type: \"Date\"\n      },\n      name: events[i].summary,\n      transitions: {\n        1: {\n          time: start.toLocaleTimeString(\"fr-FR\", { timeZone: icalToScheduleConf.timeZone }),\n          value: roomConf.tempOccupied,\n          key: \"1\"\n        },\n        2: {\n          time: end.toLocaleTimeString(\"fr-FR\", { timeZone: icalToScheduleConf.timeZone }),\n          value: null,\n          key: \"2\"\n        }\n      },\n      key: String(eventID)\n    }\n  };\n  eventID++;\n  httpRequestEventList = { ...httpRequestEventList, ...eventObject };   // Merge with the previous object\n}\n\nlet request = {\n  \"method\": \"POST\",\n  \"url\": `https://${icalToScheduleConf.controllerIPAddress}/api/rest/v2/services/bacnet/local/objects/schedules/${roomConf.scheduleID}`,\n  \"headers\": { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  \"payload\": {\n    \"special-events\": httpRequestEventList,\n    \"object-name\": roomConf.scheduleName,\n    \"schedule-default\": roomConf.tempUnoccupied\n  },\n  \"roomConf\": msg.roomConf\n};\n\nreturn request;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 820,
        "y": 220,
        "wires": [
            [
                "e62d8deddfbe7df0"
            ]
        ]
    },
    {
        "id": "fe7fb58eb39138e2",
        "type": "group",
        "z": "4e1ab562e956dc8c",
        "name": "Create Events",
        "style": {
            "stroke": "#92d04f",
            "fill": "#bfdbef",
            "label": true,
            "color": "#000000"
        },
        "nodes": [
            "8c1ae40951ecd894",
            "290efeb1f3a9dd51",
            "27631b666e3b7a80",
            "e62d8deddfbe7df0",
            "d6d4a4374e833798",
            "2036442de614c0be"
        ],
        "x": 154,
        "y": 179,
        "w": 1152,
        "h": 82
    },
    {
        "id": "43e2580ec630c632",
        "type": "ical-config",
        "url": "",
        "caldav": "",
        "caltype": "ical",
        "name": "",
        "replacedates": false,
        "usecache": false,
        "username": "",
        "password": "",
        "experimental": false,
        "calendar": "",
        "pastWeeks": "0",
        "futureWeeks": "4"
    },
    {
        "id": "554b11aa833a5cfe",
        "type": "subflow",
        "name": "Subflow 1",
        "info": "",
        "in": [
            {
                "x": 60,
                "y": 140,
                "wires": [
                    {
                        "id": "910bc8c0825eba81"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 700,
                "y": 280,
                "wires": [
                    {
                        "id": "f84666327a0b8061",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "910bc8c0825eba81",
        "type": "function",
        "z": "554b11aa833a5cfe",
        "name": "Delete schedule",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet requests = [];\nlet id = 1;\n\n// Delete all Schedule from range\nfor (let inst = icalToScheduleConf.scheduleInstanceRange[0]; inst <= icalToScheduleConf.scheduleInstanceRange[1]; inst++) {\n  {\n    requests.push({\n      id: String(id),\n      method: \"DELETE\",\n      url: `/api/rest/v2/services/bacnet/local/objects/schedules/${inst}`\n    });\n    id++\n  }\n}\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  },\n  icalToScheduleConf: icalToScheduleConf,\n  rooms: rooms\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 220,
        "y": 140,
        "wires": [
            [
                "e13d943703f8ed41",
                "f9e7c7e77a7b53e0"
            ]
        ]
    },
    {
        "id": "f9e7c7e77a7b53e0",
        "type": "http request",
        "z": "554b11aa833a5cfe",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "b5c6e6a3dffe1547",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 390,
        "y": 140,
        "wires": [
            [
                "1a07ec871e2aab10",
                "4b055597a2c5a426"
            ]
        ]
    },
    {
        "id": "e13d943703f8ed41",
        "type": "debug",
        "z": "554b11aa833a5cfe",
        "name": "Del schedule",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 410,
        "y": 80,
        "wires": []
    },
    {
        "id": "1a07ec871e2aab10",
        "type": "debug",
        "z": "554b11aa833a5cfe",
        "name": "Del schedule",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 590,
        "y": 80,
        "wires": []
    },
    {
        "id": "4b055597a2c5a426",
        "type": "function",
        "z": "554b11aa833a5cfe",
        "name": "Create Schedule",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet requests = [];\nlet id = 1;\n\nif (icalToScheduleConf.createScheduleFromURL) {\n  node.warn(\"Creating Schedule for each room...\");\n\n  for (let i = 0; i < rooms.length; i++) {\n    requests.push({\n      id: String(id),\n      method: \"POST\",\n      url: \"/api/rest/v2/services/bacnet/local/objects/add\",\n      body: {\n        \"object-type\": \"schedule\",\n        \"instance-number\": rooms[i].scheduleID,\n        \"name\": rooms[i].scheduleName\n      }\n    });\n\n    id++;\n  }\n}\n\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  },\n  icalToScheduleConf: icalToScheduleConf,\n  rooms: rooms\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 140,
        "wires": [
            [
                "92f223e4779ae0ab",
                "6eddaa99d4f64d1c"
            ]
        ]
    },
    {
        "id": "6eddaa99d4f64d1c",
        "type": "http request",
        "z": "554b11aa833a5cfe",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "b5c6e6a3dffe1547",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 750,
        "y": 140,
        "wires": [
            [
                "55f9085111453157",
                "c5b640733a832794"
            ]
        ]
    },
    {
        "id": "55f9085111453157",
        "type": "debug",
        "z": "554b11aa833a5cfe",
        "name": "schedule",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 940,
        "y": 80,
        "wires": []
    },
    {
        "id": "92f223e4779ae0ab",
        "type": "debug",
        "z": "554b11aa833a5cfe",
        "name": "schedule",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 760,
        "y": 80,
        "wires": []
    },
    {
        "id": "217ef5947d598e90",
        "type": "http request",
        "z": "554b11aa833a5cfe",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "b5c6e6a3dffe1547",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 410,
        "y": 200,
        "wires": [
            [
                "2c3c13e111bfebf3"
            ]
        ]
    },
    {
        "id": "df53f4cde3f73e9a",
        "type": "function",
        "z": "554b11aa833a5cfe",
        "name": "Delete scheduleAV",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet requests = [];\nlet id = 1;\n\n// Delete all scheduleAV from range\nfor (let inst = icalToScheduleConf.scheduleInstanceRange[0]; inst <= icalToScheduleConf.scheduleInstanceRange[1]; inst++) {\n  {\n    requests.push({\n      id: String(id),\n      method: \"DELETE\",\n      url: `/api/rest/v2/services/bacnet/local/objects/analog-values/${inst + icalToScheduleConf.scheduleAVInstanceOffset}`\n    });\n\n    id++\n  }\n}\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  },\n  icalToScheduleConf: icalToScheduleConf,\n  rooms: rooms\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 250,
        "y": 200,
        "wires": [
            [
                "217ef5947d598e90"
            ]
        ]
    },
    {
        "id": "2c3c13e111bfebf3",
        "type": "function",
        "z": "554b11aa833a5cfe",
        "name": "Create scheduleAV",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet requests = [];\nlet id = 1;\n\nif (icalToScheduleConf.createScheduleAV) {\n  node.warn(\"Creating scheduleAV for each room...\");\n  for (let i = 0; i < rooms.length; i++) {\n    requests.push({\n      id: String(id),\n      method: \"POST\",\n      url: \"/api/rest/v2/services/bacnet/local/objects/add\",\n      body: {\n        \"object-type\": \"AnalogValue\",\n        \"instance-number\": rooms[i].scheduleID + icalToScheduleConf.scheduleAVInstanceOffset,\n        name: `scheduleAV-${rooms[i].scheduleName}`\n      }\n    });\n\n    id++;\n  }\n}\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  },\n  icalToScheduleConf: icalToScheduleConf,\n  rooms: rooms\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 200,
        "wires": [
            [
                "a4fc51be6f13e199"
            ]
        ]
    },
    {
        "id": "a4fc51be6f13e199",
        "type": "http request",
        "z": "554b11aa833a5cfe",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "b5c6e6a3dffe1547",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 730,
        "y": 200,
        "wires": [
            [
                "b6c693a2f345251f",
                "34d29d034ccd1b59"
            ]
        ]
    },
    {
        "id": "c5b640733a832794",
        "type": "function",
        "z": "554b11aa833a5cfe",
        "name": "Set default",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet requests = [];\nlet id = 1;\n\nfor (let i = 0; i < rooms.length; i++) {\n\n  // Create Schedule\n  if (icalToScheduleConf.createScheduleFromURL) {\n    requests.push({\n      id: String(id),\n      method: \"POST\",\n      url: `/api/rest/v2/services/bacnet/local/objects/schedules/${rooms[i].scheduleID}`,\n      body: {\n        \"schedule-default\": 19,\n        description: `Schedule for room ${rooms[i].scheduleName}`\n      }\n    });\n\n    id++;\n  }\n}\n\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  },\n  icalToScheduleConf: icalToScheduleConf,\n  rooms: rooms\n}\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 140,
        "wires": [
            [
                "badc50490f948e26",
                "a2e217e6f74a292e"
            ]
        ]
    },
    {
        "id": "badc50490f948e26",
        "type": "http request",
        "z": "554b11aa833a5cfe",
        "name": "HTTP",
        "method": "use",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "a31ccfdac23d70b3",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1070,
        "y": 140,
        "wires": [
            [
                "4065f42d55e87b0e",
                "df53f4cde3f73e9a"
            ]
        ]
    },
    {
        "id": "a2e217e6f74a292e",
        "type": "debug",
        "z": "554b11aa833a5cfe",
        "name": "debug 8",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1120,
        "y": 80,
        "wires": []
    },
    {
        "id": "4065f42d55e87b0e",
        "type": "debug",
        "z": "554b11aa833a5cfe",
        "name": "debug 9",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1180,
        "y": 100,
        "wires": []
    },
    {
        "id": "b6c693a2f345251f",
        "type": "function",
        "z": "554b11aa833a5cfe",
        "name": "Debug controllerSetpoint",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\n\nlet requests = [];\nlet id = 12;\n\nfor (let i = 0; i < 10; i++) {\n\n  if (icalToScheduleConf.createScheduleAV) {\n    requests.push({\n      id: String(id),\n      method: \"POST\",\n      url: \"/api/rest/v2/services/bacnet/local/objects/add\",\n      body: {\n        \"object-type\": \"AnalogValue\",\n        \"instance-number\": id,\n        name: `controllerSetpoint-${id}`\n      }\n    });\n\n    id = id + 10;\n  }\n}\n\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  }\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 200,
        "wires": [
            [
                "1745bb958b7be618"
            ]
        ]
    },
    {
        "id": "1745bb958b7be618",
        "type": "http request",
        "z": "554b11aa833a5cfe",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "b5c6e6a3dffe1547",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1130,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "d9ceccd0445aea29",
        "type": "function",
        "z": "554b11aa833a5cfe",
        "name": "Delete all bindings",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet requests = [];\nlet bindingList = [];\nlet id = 1;\n\nfor (let binding in msg.payload) {\n    bindingList.push(binding);\n}\n\nfor (let i = 0; i < bindingList.length; i++) {\n    requests.push({\n        id: String(id),\n        method: \"DELETE\",\n        url: `/api/rest/v2/services/events/bindings/${bindingList[i]}`\n    });\n\n    id++\n}\n\nreturn {\n    method: \"POST\",\n    url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n    headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n    payload: {\n        requests: requests\n    },\n    icalToScheduleConf: icalToScheduleConf,\n    rooms : rooms\n};\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 280,
        "wires": [
            [
                "f84666327a0b8061"
            ]
        ]
    },
    {
        "id": "f84666327a0b8061",
        "type": "http request",
        "z": "554b11aa833a5cfe",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "b5c6e6a3dffe1547",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 570,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "34d29d034ccd1b59",
        "type": "function",
        "z": "554b11aa833a5cfe",
        "name": "List Bindings",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nreturn {\n    method: \"GET\",\n    url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/services/events/bindings\",\n    headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n    icalToScheduleConf: icalToScheduleConf,\n    rooms : rooms\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 250,
        "y": 240,
        "wires": [
            [
                "9ecc47646ba3c68d"
            ]
        ]
    },
    {
        "id": "9ecc47646ba3c68d",
        "type": "http request",
        "z": "554b11aa833a5cfe",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "b5c6e6a3dffe1547",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 210,
        "y": 280,
        "wires": [
            [
                "d9ceccd0445aea29"
            ]
        ]
    },
    {
        "id": "a31ccfdac23d70b3",
        "type": "tls-config",
        "name": "",
        "cert": "",
        "key": "",
        "ca": "",
        "certname": "",
        "keyname": "",
        "caname": "",
        "servername": "",
        "verifyservercert": false,
        "alpnprotocol": ""
    },
    {
        "id": "649f3b9dca363be2",
        "type": "tab",
        "label": "New IoT to schedule",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "1b3ed31f40feb2a8",
        "type": "group",
        "z": "649f3b9dca363be2",
        "name": "DEBUG",
        "style": {
            "label": true,
            "stroke": "#e3f3d3",
            "label-position": "n",
            "color": "#000000",
            "fill": "#e3f3d3"
        },
        "nodes": [
            "69d63da8fd0917bc",
            "0a2471193c0d3322",
            "6cd94f2378c2eb27",
            "d2671c8c7f64a6dd",
            "6493abee9d9501fc",
            "687c7706556a34f9",
            "49e6fb7e835652a5",
            "db7e42d0d4792078",
            "1e63790328fdfcde",
            "92f448c61ee2be79",
            "15f70ab236aed8ad",
            "5aeb140c89942d4b",
            "a4c0d41f095ac233",
            "a405d1bfd4b7e539"
        ],
        "x": 74,
        "y": 219,
        "w": 1032,
        "h": 162
    },
    {
        "id": "891ccdc5791bbca9",
        "type": "function",
        "z": "649f3b9dca363be2",
        "name": "TO CONFIGURE",
        "func": "//////////////////////////////////////////////\n//////////////// TO CONFIGURE ////////////////\n//////////////////////////////////////////////\n\n// 1. Create BACnet Schedule from url \nconst createScheduleFromURL = true;     // Do you want to create schedule for each Room?\nconst timeBetweenScheduleUpdate = 100;    // Seconds, Time to refresh calendar events\nconst scheduleInstanceRange = [0, 50];\nconst groupEvents = true;               // Group events in 1 event/day\nconst timeZone = 'Europe/Paris';        // What are the other options ?\nconst eventsToDiscard = [\"TO CONFIGURE\"]; // all events that content this string in their description will be ignored\nconst defaultTempOccupied = 20;\nconst defaultTempUnoccupied = 16;\nconst defaultTimeOffsetBeforeStart = 120;            // in mins\nconst defaultTimeOffsetBeforeEnd = 30;              // in mins\nconst defaultNbrDaysPreview = 10;                   // Days\nconst addSuffixToAdeURL = true;\nconst minimumSlotDuration = 0;                     // in mins\n\n// 2. Create and assign an analog value for each schedule\nconst createScheduleAV = true;\nconst scheduleAVInstanceOffset = 10000;  //  The starting instance of theses values\nconst timeBetweenScheduleAVUpdate = 10; //   Seconds\n\n// 3. Create bindings between all scheduleAV and controllerSetpoint\nconst createBindings = true; // Mandatory : Devices, deviceList\n\n/////////////////////////////\n///// Rooms Informations  ///\n/////////////////////////////\n\n/* Room Template \n{\n    // Mandatory\n    \"scheduleID\": 0,\n    \"scheduleName\": \"roomName0\",\n    \"devices\": { \"device-1\": { \"deviceNums\": [1, 2, 3], \"AVToBindName\": \"controllerSetpoint\" } },\n    \"url\": 'https://ade-usmb-ro.grenet.fr/jsp/custom/modules/plannings/direct_cal.jsp?data=b5cfb898a9c27be94975c12c6eb30e9233bdfae22c1b52e2cd88eb944acf5364c69e3e5921f4a6ebe36e93ea9658a08f,1&resources=1480&projectId=5&calType=ical&lastDate=2042-08-14',\n    \n    // Optionnal, if not specified the default value will be applied\n    \"isActive\": true,\n    \"nbrDaysPreview\" : defaultNbrDaysPreview,\n    \"tempOccupied\": defaultTempOccupied,\n    \"tempUnoccupied\": defaultTempUnoccupied,\n    \"timeOffsetBeforeStart\": defaultTimeOffsetBeforeStart,\n    \"timeOffsetBeforeEnd\": defaultTimeOffsetBeforeEnd\n*/\n\n\nlet rooms = [{\n    // Mandatory\n    \"scheduleID\": 0,\n    \"scheduleName\": \"roomName0\",\n    \"devices\": { \"device-1\": { \"deviceNums\": [1, 2, 3], \"AVToBindName\": \"controllerSetpoint\" } },\n    \"url\": 'https://ade-usmb-ro.grenet.fr/jsp/custom/modules/plannings/direct_cal.jsp?data=b5cfb898a9c27be94975c12c6eb30e9233bdfae22c1b52e2cd88eb944acf5364c69e3e5921f4a6ebe36e93ea9658a08f,1&resources=1480&projectId=5&calType=ical&lastDate=2042-08-14',\n    //\"url\": 'https://ade-usmb-ro.grenet.fr/jsp/custom/modules/plannings/direct_cal.jsp?data=b5cfb898a9c27be94975c12c6eb30e9233bdfae22c1b52e2cd88eb944acf5364c69e3e5921f4a6ebe36e93ea9658a08f,1&resources=1480&projectId=',\n    // Optionnal\n    \"isActive\": true,\n    \"tempOccupied\": defaultTempOccupied,\n    \"tempUnoccupied\": defaultTempUnoccupied,\n    \"timeOffsetBeforeStart\": defaultTimeOffsetBeforeStart,\n    \"timeOffsetBeforeEnd\": defaultTimeOffsetBeforeEnd\n},\n{\n    \"scheduleID\": 1,\n    \"scheduleName\": \"roomName1\",\n    \"devices\": { \"device-1\": { \"deviceNums\": [4, 5, 6], \"AVToBindName\": \"controllerSetpoint\" } },\n    \"tempOccupied\": defaultTempOccupied,\n    \"tempUnoccupied\": defaultTempUnoccupied,\n    \"timeOffsetBeforeStart\": defaultTimeOffsetBeforeStart,\n    \"timeOffsetBeforeEnd\": defaultTimeOffsetBeforeEnd,\n    \"url\": 'https://ade-usmb-ro.grenet.fr/jsp/custom/modules/plannings/direct_cal.jsp?data=b5cfb898a9c27be94975c12c6eb30e9233bdfae22c1b52e2cd88eb944acf5364c69e3e5921f4a6ebe36e93ea9658a08f,1&resources=1480&projectId=5&calType=ical&lastDate=2042-08-14'\n},\n{\n    \"scheduleID\": 2,\n    \"scheduleName\": \"roomName2\",\n    \"devices\": { \"device-1\": { \"deviceNums\": [7, 8, 9], \"AVToBindName\": \"controllerSetpoint\" } },\n    \"tempOccupied\": defaultTempOccupied,\n    \"tempUnoccupied\": defaultTempUnoccupied,\n    \"timeOffsetBeforeStart\": defaultTimeOffsetBeforeStart,\n    \"timeOffsetBeforeEnd\": defaultTimeOffsetBeforeEnd,\n    \"url\": 'https://ade-usmb-ro.grenet.fr/jsp/custom/modules/plannings/direct_cal.jsp?data=b5cfb898a9c27be94975c12c6eb30e9233bdfae22c1b52e2cd88eb944acf5364c69e3e5921f4a6ebe36e93ea9658a08f,1&resources=1480&projectId=5&calType=ical&lastDate=2042-08-14'\n}\n];\n\n\n/////////////////////////////////////////////////\n/////////////// DO NOT MODIFY ///////////////////\n/////////////////////////////////////////////////\n\nconst deviceList = global.get('g_deviceList');    // From LoRaBAC node\n\nfor (let device in deviceList) {\n    if (Object.keys(deviceList).some(dev => deviceList[dev].controller.ipAddress != deviceList[device].controller.ipAddress)) {\n        node.status({ fill: \"red\", shape: \"dot\", text: `Controller IP Address are not all the same in device list` });\n        return null;\n    }\n}\n\nif (scheduleInstanceRange[0] > scheduleInstanceRange[1] || scheduleInstanceRange.length !== 2) {\n    node.status({ fill: \"red\", shape: \"dot\", text: `Wrong Schedule instance range` });\n    return null;\n}\n\nif (Object.keys(rooms).length > (scheduleInstanceRange[1] - scheduleInstanceRange[0] + 1)) {\n    node.status({ fill: \"red\", shape: \"dot\", text: `Too many rooms, increase Schedule Instance Range` });\n    return null;\n}\n\nconst scheduleIDs = rooms.map(room => room.scheduleID);\nif (new Set(scheduleIDs).size !== scheduleIDs.length) {\n    node.status({ fill: \"red\", shape: \"dot\", text: `Duplicate ScheduleID in room configuration` });\n    return null;\n}\n\nconst scheduleNames = rooms.map(room => room.scheduleName);\nif (new Set(scheduleNames).size !== scheduleNames.length) {\n    node.status({ fill: \"red\", shape: \"dot\", text: `Duplicate ScheduleName in room configuration` });\n    return null;\n}\n\nfor (let room in rooms) {\n\n    if (!rooms[room].hasOwnProperty(\"scheduleName\")) {\n        node.status({ fill: \"red\", shape: \"dot\", text: `One room  has no scheduleName in room configuration` });\n        return null;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"scheduleID\") || !rooms[room].hasOwnProperty(\"scheduleName\") || !rooms[room].hasOwnProperty(\"devices\") || !rooms[room].hasOwnProperty(\"url\")) {\n        node.status({ fill: \"red\", shape: \"dot\", text: `Room  ${rooms[room].scheduleName} has no scheduleID, scheduleName, devices or url` });\n        return null;\n    }\n\n    if (rooms[room].scheduleID < scheduleInstanceRange[0] || rooms[room].scheduleID > scheduleInstanceRange[1]) {\n        node.status({ fill: \"red\", shape: \"dot\", text: `Room ${rooms[room].scheduleName} scheduleID is not in range  ${scheduleInstanceRange[0]} to ${scheduleInstanceRange[1]} ` });\n        return null;\n    }\n\n    if (!rooms[room].url) {\n        node.status({ fill: \"red\", shape: \"dot\", text: `url falsy value for ${rooms[room].scheduleName}` });\n        return null;\n    }\n\n    for (let device in rooms[room].devices) {\n\n        if (!Object.keys(deviceList).some(deviceType => deviceType == device)) {\n            node.status({ fill: \"red\", shape: \"dot\", text: `Room ${rooms[room].scheduleName} has a device type that doesn't belong to the device list` });\n            return null;\n        }\n\n        if (!Object.keys(deviceList[device].bacnet.objects).some(object => object == rooms[room].devices[device].AVToBindName)) {\n            node.status({ fill: \"red\", shape: \"dot\", text: `Room ${rooms[room].scheduleName} has a device with AVToBindName (${rooms[room].devices[device].AVToBindName}) that doesn't exist in the device List` });\n            return null;\n        } else if (deviceList[device].bacnet.objects[rooms[room].devices[device].AVToBindName].dataDirection !== \"downlink\") {\n            node.status({ fill: \"red\", shape: \"dot\", text: `${rooms[room].devices[device].AVToBindName} can't be a AVToBindName because it is not a downlink object in ${device}` });\n            return null;\n\n        }\n\n        if (rooms[room].devices[device].deviceNums.some(numDevice => numDevice > deviceList[device].identity.maxDevNum)) {\n            node.status({ fill: \"red\", shape: \"dot\", text: `Room ${rooms[room].scheduleName} has a device number that exceed the maximum (${deviceList[device].identity.maxDevNum}) for device type ${device}` });\n            return null;\n        }\n\n    }\n\n    if (!rooms[room].hasOwnProperty(\"isActive\")) {\n        rooms[room].isActive = true;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"timeZone\")) {\n        rooms[room].timeZone = timeZone;\n    }\n    if (!rooms[room].timeZone) {\n        node.status({ fill: \"red\", shape: \"dot\", text: `timeZone falsy value for ${rooms[room].scheduleName} ` });\n        return null;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"tempUnoccupied\")) {\n        rooms[room].tempUnoccupied = defaultTempUnoccupied;\n    }\n    if (!rooms[room].tempUnoccupied) {\n        node.status({ fill: \"red\", shape: \"dot\", text: `tempUnoccupied falsy value : ${rooms[room].tempUnoccupied} ` });\n        return null;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"tempOccupied\")) {\n        rooms[room].tempOccupied = defaultTempOccupied;\n    }\n    if (!rooms[room].tempOccupied) {\n        node.status({ fill: \"red\", shape: \"dot\", text: `tempOccupied falsy value : ${rooms[room].tempOccupied} ` });\n        return null;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"nbrDaysPreview\")) {\n        rooms[room].nbrDaysPreview = defaultNbrDaysPreview;\n    }\n    if (!rooms[room].nbrDaysPreview) {\n        node.status({ fill: \"red\", shape: \"dot\", text: `nbrDaysPreview falsy value : ${rooms[room].nbrDaysPreview} ` });\n        return null;\n    }\n\n    if (addSuffixToAdeURL) {\n        const date = new Date();\n        date.setDate(date.getDate() + rooms[room].nbrDaysPreview);\n        let adeSuffixe = date.toISOString().slice(0, 10)\n        if (rooms[room].url.includes(\"&lastDate\")) {\n            rooms[room].url = rooms[room].url.replace(/&lastDate=\\d{4}-\\d{2}-\\d{2}/, `&lastDate=${adeSuffixe}`);\n        }\n        else {\n            rooms[room].url += `&lastDate=${adeSuffixe}`;\n        }\n    }\n    //node.warn(rooms[room].url);\n\n}\n\n\nnode.status({ fill: \"green\", shape: \"dot\", text: `Configuration OK` });\n\nfor (let device in deviceList) {\n    const buffer = Buffer.from(deviceList[device].controller.login + ':' + deviceList[device].controller.password);\n    deviceList[device].controller.httpAuthentication = \"Basic \" + buffer.toString('base64');\n}\n\n// Store variables\nlet icalToScheduleConf = {\n    controllerIPAddress: deviceList[Object.keys(deviceList)[0]].controller.ipAddress,\n    controllerLogin: deviceList[Object.keys(deviceList)[0]].controller.login,\n    controllerPassword: deviceList[Object.keys(deviceList)[0]].controller.password,\n    httpAuthentication: deviceList[Object.keys(deviceList)[0]].controller.httpAuthentication,\n    createScheduleFromURL: createScheduleFromURL,\n    createScheduleAV: createScheduleAV,\n    createBindings: createBindings,\n    timeBetweenScheduleUpdate: timeBetweenScheduleUpdate,\n    timeBetweenScheduleAVUpdate: timeBetweenScheduleAVUpdate,\n    defaultTimeOffsetBeforeStart: defaultTimeOffsetBeforeStart,\n    defaultTimeOffsetBeforeEnd: defaultTimeOffsetBeforeEnd,\n    scheduleInstanceRange: scheduleInstanceRange,\n    groupEvents: groupEvents,\n    timeZone: timeZone,\n    eventsToDiscard: eventsToDiscard,\n    scheduleAVInstanceOffset: scheduleAVInstanceOffset,\n    minimumSlotDuration: minimumSlotDuration,\n}\n\n//flow.set('f_icalToScheduleConf', icalToScheduleConf);\n//flow.set('f_rooms', rooms);\n\nreturn msg = {\n    icalToScheduleConf: icalToScheduleConf,\n    rooms : rooms\n};\n\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 250,
        "y": 80,
        "wires": [
            [
                "9a8158abd737cd6d",
                "b52da3203f687fdf"
            ]
        ],
        "icon": "node-red/cog.svg"
    },
    {
        "id": "63dafd9ff73e5e6d",
        "type": "inject",
        "z": "649f3b9dca363be2",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0.1",
        "topic": "",
        "x": 115,
        "y": 80,
        "wires": [
            [
                "891ccdc5791bbca9"
            ]
        ],
        "l": false
    },
    {
        "id": "69d63da8fd0917bc",
        "type": "inject",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 135,
        "y": 260,
        "wires": [
            [
                "0a2471193c0d3322"
            ]
        ],
        "l": false
    },
    {
        "id": "0a2471193c0d3322",
        "type": "function",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "List Schedules",
        "func": "let icalToScheduleConf = flow.get('f_icalToScheduleConf');\n\nreturn {\n    \"method\": \"GET\",\n    \"url\": \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/services/bacnet/local/objects/schedules\",\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" }\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 260,
        "wires": [
            [
                "6cd94f2378c2eb27"
            ]
        ]
    },
    {
        "id": "6cd94f2378c2eb27",
        "type": "http request",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "b5c6e6a3dffe1547",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 430,
        "y": 260,
        "wires": [
            [
                "d2671c8c7f64a6dd"
            ]
        ]
    },
    {
        "id": "d2671c8c7f64a6dd",
        "type": "debug",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "Schedules",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 990,
        "y": 260,
        "wires": []
    },
    {
        "id": "6493abee9d9501fc",
        "type": "inject",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 135,
        "y": 300,
        "wires": [
            [
                "687c7706556a34f9"
            ]
        ],
        "l": false
    },
    {
        "id": "687c7706556a34f9",
        "type": "function",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "List Bindings",
        "func": "let icalToScheduleConf = flow.get('f_icalToScheduleConf');\n\nreturn {\n    \"method\": \"GET\",\n    \"url\": \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/services/events/bindings\",\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication , \"Content-Type\": \"application/json\" }\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 270,
        "y": 300,
        "wires": [
            [
                "49e6fb7e835652a5"
            ]
        ]
    },
    {
        "id": "49e6fb7e835652a5",
        "type": "http request",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "b5c6e6a3dffe1547",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 430,
        "y": 300,
        "wires": [
            [
                "db7e42d0d4792078"
            ]
        ]
    },
    {
        "id": "db7e42d0d4792078",
        "type": "debug",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "Bindings",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 980,
        "y": 300,
        "wires": []
    },
    {
        "id": "1e63790328fdfcde",
        "type": "function",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "Delete all bindings",
        "func": "let icalToScheduleConf = flow.get('f_icalToScheduleConf');\n\nlet requests = [];\nlet bindingList = [];\nlet id = 1;\n\nfor(let binding in msg.payload){\n    bindingList.push(binding);\n}\n\n\nfor (let i = 0 ; i < bindingList.length ; i++) {\nrequests.push(JSON.parse(`{ \"id\": \"${id}\", \"method\": \"DELETE\", \"url\": \"/api/rest/v2/services/events/bindings/${bindingList[i]}\"}`)); //Bindings name\n    id++\n}\n\n\nreturn {\n    \"method\": \"POST\",\n    \"url\": \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication , \"Content-Type\": \"application/json\" },\n    \"payload\": {\n        \"requests\": requests\n    }\n};\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 340,
        "wires": [
            [
                "5aeb140c89942d4b"
            ]
        ]
    },
    {
        "id": "92f448c61ee2be79",
        "type": "inject",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 135,
        "y": 340,
        "wires": [
            [
                "a4c0d41f095ac233"
            ]
        ],
        "l": false
    },
    {
        "id": "15f70ab236aed8ad",
        "type": "debug",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "Bindings",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 980,
        "y": 340,
        "wires": []
    },
    {
        "id": "5aeb140c89942d4b",
        "type": "http request",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "b5c6e6a3dffe1547",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 790,
        "y": 340,
        "wires": [
            [
                "15f70ab236aed8ad"
            ]
        ]
    },
    {
        "id": "a4c0d41f095ac233",
        "type": "function",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "List Bindings",
        "func": "let icalToScheduleConf = flow.get('f_icalToScheduleConf');\n\nreturn {\n    \"method\": \"GET\",\n    \"url\": \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/services/events/bindings\",\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication , \"Content-Type\": \"application/json\" }\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 270,
        "y": 340,
        "wires": [
            [
                "a405d1bfd4b7e539"
            ]
        ]
    },
    {
        "id": "a405d1bfd4b7e539",
        "type": "http request",
        "z": "649f3b9dca363be2",
        "g": "1b3ed31f40feb2a8",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "b5c6e6a3dffe1547",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 430,
        "y": 340,
        "wires": [
            [
                "1e63790328fdfcde"
            ]
        ]
    },
    {
        "id": "7295b86b0473ec3e",
        "type": "function",
        "z": "649f3b9dca363be2",
        "name": "create Bindings",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\nlet deviceList = flow.get(\"g_deviceList\");\nnode.warn(deviceList);\n\n\n\nlet requests = [];\nlet id = 1;\n\nif (icalToScheduleConf.createBindings) {\n  node.warn(\"Creating bindings for each room...\");\n\n  /******  For Each room  ******/\n  for (let i = 0; i < rooms.length; i++) {\n    let deviceTypes = Object.keys(rooms[i].devices);\n    let scheduleName = rooms[i].scheduleName;\n    let scheduleID = rooms[i].scheduleID;\n    let scheduleAVinstanceNum = rooms[i].scheduleID + icalToScheduleConf.scheduleAVInstanceOffset;\n\n    /******  Each device type  ******/\n    for (let j = 0; j < deviceTypes.length; j++) {\n      let AVToBindName = rooms[i].devices[deviceTypes[j]].AVToBindName;\n      let AVToBindNameInstanceNumOffset = deviceList[deviceTypes[j]].bacnet.objects[rooms[i].devices[deviceTypes[j]].AVToBindName].instanceNum;\n      let offsetAV = deviceList[deviceTypes[j]].bacnet.offsetAV;\n\n      /******  Each device Num  ******/\n      for (let k = 0; k < rooms[i].devices[deviceTypes[j]].deviceNums.length; k++) {\n        let deviceNum = rooms[i].devices[deviceTypes[j]].deviceNums[k];\n        let AVToBindNameInstanceNum = deviceList[deviceTypes].bacnet.instanceRangeAV * deviceNum + AVToBindNameInstanceNumOffset + offsetAV;\n\n        requests.push({\n          id: String(id),\n          method: \"POST\",\n          url: `/api/rest/v2/services/events/bindings/binding_scheduleAV-${scheduleName}_${AVToBindName}-${AVToBindNameInstanceNum}`,\n          body: {\n            //key: \"Don't need this??\",\n            type: \"ControlElement\",\n            \"element-a\": `/services/bacnet/local/objects/analog-values/${icalToScheduleConf.scheduleAVInstanceOffset + scheduleID}`,\n            \"element-b\": `/services/bacnet/local/objects/analog-values/${AVToBindNameInstanceNum}`,\n            initialize: \"a-to-b\",\n            \"sync-a-to-b\": {\n              options: { priorities: true, \"write-priority\": 14, value: false, \"out-of-service\": true },\n              triggers: { \"1\": { key: \"1\", \"min-sync-time\": 0.0, type: \"OnChange\" } }\n            }\n          }\n        });\n        id++;\n      }\n    }\n  }\n}\n\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  },\n  icalToScheduleConf: icalToScheduleConf,\n  rooms: rooms\n}\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 80,
        "wires": [
            [
                "5825605fe68c0992"
            ]
        ]
    },
    {
        "id": "5825605fe68c0992",
        "type": "http request",
        "z": "649f3b9dca363be2",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "2418490b3512393e",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 830,
        "y": 80,
        "wires": [
            [
                "69da3e326d08749d"
            ]
        ]
    },
    {
        "id": "9a8158abd737cd6d",
        "type": "subflow:554b11aa833a5cfe",
        "z": "649f3b9dca363be2",
        "name": "Configuration",
        "x": 470,
        "y": 80,
        "wires": [
            [
                "7295b86b0473ec3e"
            ]
        ]
    },
    {
        "id": "69da3e326d08749d",
        "type": "subflow:4e1ab562e956dc8c",
        "z": "649f3b9dca363be2",
        "name": "",
        "x": 1000,
        "y": 80,
        "wires": []
    },
    {
        "id": "b52da3203f687fdf",
        "type": "subflow:bba8d161678c81a7",
        "z": "649f3b9dca363be2",
        "name": "scheduleAV update",
        "x": 490,
        "y": 140,
        "wires": []
    },
    {
        "id": "b5c6e6a3dffe1547",
        "type": "tls-config",
        "name": "",
        "cert": "",
        "key": "",
        "ca": "",
        "certname": "",
        "keyname": "",
        "caname": "",
        "servername": "",
        "verifyservercert": false,
        "alpnprotocol": ""
    },
    {
        "id": "2418490b3512393e",
        "type": "tls-config",
        "name": "",
        "cert": "",
        "key": "",
        "ca": "",
        "certname": "",
        "keyname": "",
        "caname": "",
        "servername": "",
        "verifyservercert": false,
        "alpnprotocol": ""
    }
]