[
    {
        "id": "748d34b69945229e",
        "type": "subflow",
        "name": "Ical Server status",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 120,
                "wires": [
                    {
                        "id": "0215e2a57b3949af"
                    }
                ]
            }
        ],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99",
        "status": {
            "x": 536.0000095367432,
            "y": 72.00000762939453,
            "wires": [
                {
                    "id": "a78fc4570d60a50e",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "0215e2a57b3949af",
        "type": "function",
        "z": "748d34b69945229e",
        "g": "56ddcac0c0ce91bd",
        "name": "Rooms",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\nlet controlledByEventFromIcalNbr = rooms.filter(element => element.control === \"controlledByEventFromIcal\").length;\n\nfunction createEvent() {\n    icalToScheduleConf.controlledByEventFromIcalNbr = controlledByEventFromIcalNbr;\n    icalToScheduleConf.startTimeUpdateSchedule = Date.now();\n    icalToScheduleConf.roomCounter = 0;\n\n    flow.set('sf_icalToScheduleConf', icalToScheduleConf);\n    for (let j = 0; j < rooms.length; j++) {\n        if (rooms[j].control === \"controlledByEventFromIcal\" ) {\n            node.send({\n                action: \"queue\",\n                payload: rooms[j]\n            });\n        }\n    }\n}\n\ncreateEvent();\nsetInterval(createEvent, 60*60*1000); \n\n\n\n\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 200,
        "y": 120,
        "wires": [
            [
                "a78fc4570d60a50e"
            ]
        ],
        "icon": "node-red/parser-json.svg"
    },
    {
        "id": "5c689af129e4aca8",
        "type": "function",
        "z": "748d34b69945229e",
        "g": "56ddcac0c0ce91bd",
        "name": "Unqueue",
        "func": "let icalToScheduleConf = flow.get('sf_icalToScheduleConf');\n\nicalToScheduleConf.roomCounter++;\n\nif(icalToScheduleConf.roomCounter % icalToScheduleConf.controlledByEventFromIcalNbr == 0){\n    node.warn(`${icalToScheduleConf.controlledByEventFromIcalNbr} URL processed in ${(Date.now() - icalToScheduleConf.startTimeUpdateSchedule) / 1000} s`);\n}\n\nflow.set('sf_icalToScheduleConf',icalToScheduleConf);\n\nmsg.action = \"unqueue\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "//flow.set('f_isControllerReady', true);\n",
        "finalize": "",
        "libs": [],
        "x": 1199.999984741211,
        "y": 121.00003623962402,
        "wires": [
            [
                "3824cb3cf8c0621c"
            ]
        ]
    },
    {
        "id": "a78fc4570d60a50e",
        "type": "function",
        "z": "748d34b69945229e",
        "g": "56ddcac0c0ce91bd",
        "name": "Room Queue",
        "func": "let roomsQueue = flow.get('f_roomsQueue');\nconst maxQueueSize = 40;\n\n\n////////////////// Queue ////////////////\nif (msg.action === \"queue\") {\n    if (roomsQueue.length >= maxQueueSize) {\n        node.error(`Room queue has exeeded its maximum size ${maxQueueSize}`);\n        return null;\n    }\n    else if (roomsQueue.length == 0 && flow.get('f_initialStart')) {\n        // First message, no need to queue.\n        flow.set('f_initialStart', false);\n        node.warn(\"Testing ical server for each URL...\");\n        return {\n            \"url\": msg.payload.url,\n            \"timezone\": msg.payload.timeZone,\n            \"preview\": msg.payload.nbrDaysPreview,\n            \"roomConf\": msg.payload,\n            \"status\": { fill: \"green\", shape: \"dot\", text: `Room queue size : ${roomsQueue.length}` }\n        }\n    }\n    else {\n        //node.warn(\"Other message, Queue\");\n        roomsQueue.push(msg.payload);\n        flow.set('f_roomsQueue', roomsQueue);\n    }\n}\n\n////////////////// Unqueue ////////////////\nelse if (msg.action === \"unqueue\") {\n    if (roomsQueue.length === 0) {\n        flow.set('f_initialStart', true);\n        //node.warn(\"Unqueue with lenght == 0, initialStart = true\");\n    }\n    else {\n        let newRoom = roomsQueue.shift();\n        flow.set('f_roomsQueue', roomsQueue);\n        //node.warn(\"Unqueue\");\n        return {\n            \"url\": newRoom.url,\n            \"timezone\": newRoom.timeZone,\n            \"preview\": msg.payload.nbrDaysPreview,\n            \"roomConf\": newRoom,\n            \"status\": { fill: \"green\", shape: \"dot\", text: `Room queue size : ${roomsQueue.length}` }\n        }\n    }\n}\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "let roomsQueue = [];\nflow.set('f_roomsQueue', roomsQueue);\n\nlet initialStart = true;\nflow.set('f_initialStart', initialStart);\n",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 120,
        "wires": [
            [
                "5671a1e5f3287655"
            ]
        ]
    },
    {
        "id": "5671a1e5f3287655",
        "type": "ical-upcoming",
        "z": "748d34b69945229e",
        "g": "56ddcac0c0ce91bd",
        "confignode": "f73555ac13078ac6",
        "timeout": "",
        "timeoutUnits": "seconds",
        "cron": "",
        "name": "Get Room calendar",
        "offsettype": "",
        "offset": "",
        "offsetUnitstype": "",
        "offsetUnits": "",
        "eventtypes": "events",
        "eventtypestype": "eventtypes",
        "calendar": "",
        "calendartype": "str",
        "triggertype": "trigger",
        "trigger": "always",
        "timezone": "",
        "timezonetype": "str",
        "dateformat": "{ \"timeStyle\": \"short\", \"dateStyle\": \"short\" }",
        "dateformattype": "json",
        "language": "en",
        "languagetype": "language",
        "filterProperty": "summary",
        "filterPropertytype": "filterProperty",
        "filterOperator": "between",
        "filterOperatortype": "filterOperator",
        "filtertype": "str",
        "filter2type": "str",
        "filter2": "",
        "filter": "",
        "checkall": false,
        "endpreview": "",
        "endpreviewUnits": "",
        "previewtype": "num",
        "preview": "20",
        "previewUnitstype": "previewUnits",
        "previewUnits": "days",
        "pastviewtype": "num",
        "pastview": "0",
        "pastviewUnits": "days",
        "pastviewUnitstype": "pastviewUnits",
        "x": 630,
        "y": 120,
        "wires": [
            [
                "5648769ea9ad31f9"
            ]
        ]
    },
    {
        "id": "5648769ea9ad31f9",
        "type": "function",
        "z": "748d34b69945229e",
        "g": "56ddcac0c0ce91bd",
        "name": "Error Handle",
        "func": "let roomConf = msg.roomConf;\nlet errorIcalTab = global.get('g_errorIcalTab');\n\nlet status = msg.error ? false : true;\n\nlet since;\nif (errorIcalTab[roomConf.scheduleID] == undefined){\n    since = (new Date()).toLocaleString(\"fr-FR\", { timeZone: \"Europe/Paris\" });\n} else if (status != errorIcalTab[roomConf.scheduleID][\"Status\"] ){\n    since = (new Date()).toLocaleString(\"fr-FR\", { timeZone: \"Europe/Paris\" });\n}else {\n    since = errorIcalTab[roomConf.scheduleID][\"Since\"];\n}\n\nlet roomName = roomConf.scheduleName;\n\nlet lastError = \"\";\nif ((msg.error + \"\").includes(\"ENOTFOUND\")) {\n    lastError = \"ENOTFOUND\";\n} else if ((msg.error + \"\").includes(\"ECONNRESET\")) {\n    lastError = \"ECONNRESET\";\n} else if ((msg.error + \"\").includes(\"ERROR 404\")) {\n    lastError = \"ERROR 404\";\n} else if ((msg.error + \"\").includes(\"ETIMEDOUT\")) {\n    lastError = \"ETIMEDOUT\";\n} else if ((msg.error + \"\").includes(\"ERROR 500\")) {\n    lastError = \"ERROR 500\";\n} else if (msg.error) {\n    lastError = \"OTHER\";\n} else {\n    lastError = errorIcalTab[roomConf.scheduleID]?.[\"Last Error\"] ?? \"Never Happenned\";\n}\n\nlet totalErrorTolal;\nif (msg.error) {\n    totalErrorTolal = (errorIcalTab[roomConf.scheduleID]?.[\"Total errors\"] ?? 0) + 1;\n}\nelse {\n    totalErrorTolal = (errorIcalTab[roomConf.scheduleID]?.[\"Total errors\"] ?? 0);\n}\n\nerrorIcalTab[roomConf.scheduleID] = {\n    \"Status\": status,\n    \"Since\" : since,\n    \"Room Name\": roomConf.scheduleName,\n    \"Last Error\": lastError,\n    \"Total errors\": totalErrorTolal\n};\n\n\nglobal.set('g_errorIcalTab', errorIcalTab);\n\nif (msg.error) {\n    return [null, msg];\n}\nelse {\n    return [msg, null];\n}\n\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\n//let errorIcalObj = {};\nlet errorIcalTab = [];\n//global.set('g_errorIcalObj', errorIcalObj);\nglobal.set('g_errorIcalTab', errorIcalTab);\n\n",
        "finalize": "",
        "libs": [],
        "x": 840,
        "y": 120,
        "wires": [
            [
                "e03dd46e6be64489"
            ],
            [
                "5c689af129e4aca8"
            ]
        ]
    },
    {
        "id": "e03dd46e6be64489",
        "type": "function",
        "z": "748d34b69945229e",
        "g": "56ddcac0c0ce91bd",
        "name": "function 1",
        "func": "//Function when no error happened\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1019.9999847412109,
        "y": 81.00003623962402,
        "wires": [
            [
                "5c689af129e4aca8"
            ]
        ]
    },
    {
        "id": "5599502802f84b66",
        "type": "inject",
        "z": "748d34b69945229e",
        "g": "4581681af4424807",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "g_errorIcalTab",
        "payloadType": "global",
        "x": 460,
        "y": 240,
        "wires": [
            [
                "0229ab11fa6b9c32"
            ]
        ]
    },
    {
        "id": "ec1435ac53c536d4",
        "type": "ui-table",
        "z": "748d34b69945229e",
        "g": "4581681af4424807",
        "group": "8d1a2ecbd08fcd88",
        "name": "Status table",
        "label": "",
        "order": 1,
        "width": 0,
        "height": 0,
        "maxrows": 0,
        "passthru": false,
        "autocols": false,
        "showSearch": false,
        "deselect": false,
        "selectionType": "none",
        "columns": [
            {
                "title": "Status",
                "key": "Status",
                "keyType": "key",
                "type": "tickcross",
                "width": "",
                "align": "center"
            },
            {
                "title": "Since",
                "key": "Since",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "center"
            },
            {
                "title": "Room Name",
                "key": "Room Name",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "center"
            },
            {
                "title": "Last Error",
                "key": "Last Error",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "center"
            },
            {
                "title": "Total errors",
                "key": "Total errors",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "center"
            }
        ],
        "mobileBreakpoint": "sm",
        "mobileBreakpointType": "defaults",
        "action": "replace",
        "x": 850,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "0229ab11fa6b9c32",
        "type": "function",
        "z": "748d34b69945229e",
        "g": "4581681af4424807",
        "name": "Filter",
        "func": "\n//node.warn(msg.payload);\n\nreturn {\n    payload : msg.payload.filter(element => element != undefined)\n   // payload : 10\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 240,
        "wires": [
            [
                "ec1435ac53c536d4"
            ]
        ]
    },
    {
        "id": "8d1a2ecbd08fcd88",
        "type": "ui-group",
        "z": "748d34b69945229e",
        "name": "ADE Server Status",
        "page": "22e0741a4a10bee3",
        "width": 6,
        "height": 1,
        "order": 1,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "3824cb3cf8c0621c",
        "type": "junction",
        "z": "748d34b69945229e",
        "g": "56ddcac0c0ce91bd",
        "x": 299.99998474121094,
        "y": 121.00003623962402,
        "wires": [
            [
                "a78fc4570d60a50e"
            ]
        ]
    },
    {
        "id": "56ddcac0c0ce91bd",
        "type": "group",
        "z": "748d34b69945229e",
        "name": "Create events",
        "style": {
            "fill": "#bfdbef",
            "label": true,
            "label-position": "n",
            "color": "#000000"
        },
        "nodes": [
            "0215e2a57b3949af",
            "5c689af129e4aca8",
            "a78fc4570d60a50e",
            "5671a1e5f3287655",
            "5648769ea9ad31f9",
            "e03dd46e6be64489",
            "3824cb3cf8c0621c"
        ],
        "x": 114,
        "y": 40.00003623962402,
        "w": 1171.999984741211,
        "h": 122
    },
    {
        "id": "4581681af4424807",
        "type": "group",
        "z": "748d34b69945229e",
        "name": "Onboard GTC",
        "style": {
            "label": true,
            "label-position": "n",
            "color": "#000000"
        },
        "nodes": [
            "5599502802f84b66",
            "ec1435ac53c536d4",
            "0229ab11fa6b9c32"
        ],
        "x": 314,
        "y": 199,
        "w": 632,
        "h": 82
    },
    {
        "id": "22e0741a4a10bee3",
        "type": "ui-page",
        "name": "ADE server",
        "ui": "e09cfd48728aad39",
        "path": "/ade",
        "icon": "home",
        "layout": "grid",
        "theme": "ce70820df616b739",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 1,
        "className": "",
        "visible": true,
        "disabled": false
    },
    {
        "id": "e09cfd48728aad39",
        "type": "ui-base",
        "name": "Default UI",
        "path": "/dashboard",
        "appIcon": "",
        "includeClientData": true,
        "acceptsClientConfig": [
            "ui-notification",
            "ui-control"
        ],
        "showPathInSidebar": false,
        "headerContent": "page",
        "navigationStyle": "default",
        "titleBarStyle": "default",
        "showReconnectNotification": true,
        "notificationDisplayTime": 1,
        "showDisconnectNotification": true,
        "allowInstall": true
    },
    {
        "id": "ce70820df616b739",
        "type": "ui-theme",
        "name": "Default Theme",
        "colors": {
            "surface": "#ffffff",
            "primary": "#0094CE",
            "bgPage": "#eeeeee",
            "groupBg": "#ffffff",
            "groupOutline": "#cccccc"
        },
        "sizes": {
            "density": "default",
            "pagePadding": "12px",
            "groupGap": "12px",
            "groupBorderRadius": "4px",
            "widgetGap": "12px"
        }
    },
    {
        "id": "69fa40f5c518b9d9",
        "type": "subflow",
        "name": "scheduleAV update",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 100,
                "y": 140,
                "wires": [
                    {
                        "id": "d9c8245f9b935b72"
                    }
                ]
            }
        ],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "d9c8245f9b935b72",
        "type": "function",
        "z": "69fa40f5c518b9d9",
        "g": "562449522d8cb9db",
        "name": "Get schedule value",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet property_references = [];\n\nfunction getSchedulePresentValue() {\n  node.warn(\"Updating scheduleAV...\");\n  for (let room in rooms) {\nif (rooms[room].control === \"controlledByEventFromIcal\" || rooms[room].control === \"controlledBySchedule\") {\n      let temp = '{ \"type\": \"Schedule\", \"instance\": ' + rooms[room].scheduleID + ', \"property\": \"presentValue\"}';\n      property_references.push(JSON.parse(temp));\n    }\n  }\n  node.send({\n    method: \"POST\",\n    url: `https://${icalToScheduleConf.controllerIPAddress}/api/rest/v2/services/bacnet/local/objects/read-property-multiple`,\n    headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n    payload: {\n      \"encode\": \"text\",\n      \"property-references\": property_references\n    },\n    icalToScheduleConf: icalToScheduleConf,\n    rooms: rooms\n  });\n}\n\nsetTimeout(() => {\n  getSchedulePresentValue();\n  setInterval(getSchedulePresentValue, icalToScheduleConf.timeBetweenScheduleAVUpdate * 1000);\n}, 5000);\n\n\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 270,
        "y": 140,
        "wires": [
            [
                "eefe6f4e18368b8d"
            ]
        ]
    },
    {
        "id": "eefe6f4e18368b8d",
        "type": "http request",
        "z": "69fa40f5c518b9d9",
        "g": "562449522d8cb9db",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 450,
        "y": 140,
        "wires": [
            [
                "05935cade0f28272"
            ]
        ]
    },
    {
        "id": "05935cade0f28272",
        "type": "function",
        "z": "69fa40f5c518b9d9",
        "g": "562449522d8cb9db",
        "name": "Write scheduleAV",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet property_references = [];\nlet results = msg.payload.results;\nlet setpoint;\n\n\nfor (let i = 0; i < results.length; i++) {\n  setpoint = results[i].value;\n  if (!setpoint || setpoint.includes(\"Null\")) {\n    node.warn(`Schedule ${results[i].instance} returns 0 or NULL`);\n  } else if (setpoint.includes(\"Unknown Object\")){\n    node.warn(`Schedule ${results[i].instance} doesn't exist`);\n  }else{\n  let temp = '{ \"type\": \"analogValue\", \"instance\": ' + (icalToScheduleConf.scheduleAVInstanceOffset + results[i].instance) + ', \"property\": \"presentValue\", \"value\": ' + setpoint + ' }';\n  property_references.push(JSON.parse(temp));\n  }\n}\n\n\nreturn {\n  method: \"POST\",\n  url: `https://${icalToScheduleConf.controllerIPAddress}/api/rest/v2/services/bacnet/local/objects/write-property-multiple`,\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    \"encode\": \"text\",\n    \"property-references\": property_references\n  }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 140,
        "wires": [
            [
                "309c45d1bf3bbd51"
            ]
        ]
    },
    {
        "id": "309c45d1bf3bbd51",
        "type": "http request",
        "z": "69fa40f5c518b9d9",
        "g": "562449522d8cb9db",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 810,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "562449522d8cb9db",
        "type": "group",
        "z": "69fa40f5c518b9d9",
        "name": "Link schedules and  scheduleAV",
        "style": {
            "fill": "#ffefbf",
            "label": true,
            "color": "#000000",
            "stroke": "#d1d1d1",
            "label-position": "n"
        },
        "nodes": [
            "d9c8245f9b935b72",
            "eefe6f4e18368b8d",
            "05935cade0f28272",
            "309c45d1bf3bbd51"
        ],
        "x": 154,
        "y": 99,
        "w": 732,
        "h": 82
    },
    {
        "id": "f33b48a9db5775f9",
        "type": "subflow",
        "name": "Configuration",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 100,
                "wires": [
                    {
                        "id": "0a22dbefe945e1a5"
                    }
                ]
            }
        ],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99",
        "status": {
            "x": 560,
            "y": 460,
            "wires": [
                {
                    "id": "cf30b1fd186a52f4",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "0a22dbefe945e1a5",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "7887c949a2fa716c",
        "name": "Delete schedule",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet requests = [];\nlet id = 1;\n\n// Delete all Schedule from range\nfor (let inst = icalToScheduleConf.scheduleInstanceRange[0]; inst <= icalToScheduleConf.scheduleInstanceRange[1]; inst++) {\n  {\n    requests.push({\n      id: String(id),\n      method: \"DELETE\",\n      url: `/api/rest/v2/services/bacnet/local/objects/schedules/${inst}`\n    });\n    id++\n  }\n}\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  },\n  icalToScheduleConf: icalToScheduleConf,\n  rooms: rooms\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 220,
        "y": 100,
        "wires": [
            [
                "eff1beb6101e98b5"
            ]
        ]
    },
    {
        "id": "eff1beb6101e98b5",
        "type": "http request",
        "z": "f33b48a9db5775f9",
        "g": "7887c949a2fa716c",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 410,
        "y": 100,
        "wires": [
            [
                "d2b052b0dded9737"
            ]
        ]
    },
    {
        "id": "d2b052b0dded9737",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "7887c949a2fa716c",
        "name": "Create Schedule",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet requests = [];\nlet id = 1;\nlet scheduleNbr = 0;\n\nfor (let i = 0; i < rooms.length; i++) {\n  if (rooms[i].control === \"controlledByEventFromIcal\" || rooms[i].control === \"controlledBySchedule\") {\n    scheduleNbr++;\n  }\n}\n\nnode.warn(`Creating ${scheduleNbr} Schedules...`);\n\nfor (let i = 0; i < rooms.length; i++) {\n  if (rooms[i].control === \"controlledByEventFromIcal\" || rooms[i].control === \"controlledBySchedule\") {\n    requests.push({\n      id: String(id),\n      method: \"POST\",\n      url: \"/api/rest/v2/services/bacnet/local/objects/add\",\n      body: {\n        \"object-type\": \"schedule\",\n        \"instance-number\": rooms[i].scheduleID,\n        \"name\": rooms[i].scheduleName\n      }\n    });\n\n    id++;\n  }\n}\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  },\n  icalToScheduleConf: icalToScheduleConf,\n  rooms: rooms\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 100,
        "wires": [
            [
                "257e24ab3c5da25d"
            ]
        ]
    },
    {
        "id": "257e24ab3c5da25d",
        "type": "http request",
        "z": "f33b48a9db5775f9",
        "g": "7887c949a2fa716c",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 770,
        "y": 100,
        "wires": [
            [
                "c7f4461a9273c688"
            ]
        ]
    },
    {
        "id": "b832441d55badea7",
        "type": "http request",
        "z": "f33b48a9db5775f9",
        "g": "60c3679c606b47f2",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 410,
        "y": 220,
        "wires": [
            [
                "9d9893690a03cd25"
            ]
        ]
    },
    {
        "id": "a6e3cfb05519d183",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "60c3679c606b47f2",
        "name": "Delete scheduleAV",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet requests = [];\nlet id = 1;\n\n// Delete all scheduleAV from range\nfor (let inst = icalToScheduleConf.scheduleInstanceRange[0]; inst <= icalToScheduleConf.scheduleInstanceRange[1]; inst++) {\n  {\n    requests.push({\n      id: String(id),\n      method: \"DELETE\",\n      url: `/api/rest/v2/services/bacnet/local/objects/analog-values/${inst + icalToScheduleConf.scheduleAVInstanceOffset}`\n    });\n\n    id++\n  }\n}\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  },\n  icalToScheduleConf: icalToScheduleConf,\n  rooms: rooms\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 230,
        "y": 220,
        "wires": [
            [
                "b832441d55badea7"
            ]
        ]
    },
    {
        "id": "9d9893690a03cd25",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "60c3679c606b47f2",
        "name": "Create scheduleAV",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet requests = [];\nlet id = 1;\nlet scheduleAVNbr = 0;\n\nfor (let i = 0; i < rooms.length; i++) {\n  if (rooms[i].control === \"controlledByEventFromIcal\" || rooms[i].control === \"controlledBySchedule\" || rooms[i].control === \"controlledByConstant\") {\n    scheduleAVNbr++;\n  }\n}\n\nnode.warn(`Creating ${scheduleAVNbr} scheduleAV...`);\n\nfor (let i = 0; i < rooms.length; i++) {\n  if (rooms[i].control === \"controlledByEventFromIcal\" || rooms[i].control === \"controlledBySchedule\" || rooms[i].control === \"controlledByConstant\") {\n    requests.push({\n      id: String(id),\n      method: \"POST\",\n      url: \"/api/rest/v2/services/bacnet/local/objects/add\",\n      body: {\n        \"object-type\": \"AnalogValue\",\n        \"instance-number\": rooms[i].scheduleID + icalToScheduleConf.scheduleAVInstanceOffset,\n        name: `scheduleAV-${rooms[i].scheduleName}`\n      }\n    });\n\n    id++;\n  }\n}\n\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  },\n  icalToScheduleConf: icalToScheduleConf,\n  rooms: rooms\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 220,
        "wires": [
            [
                "8114bf7d0dc66b62"
            ]
        ]
    },
    {
        "id": "8114bf7d0dc66b62",
        "type": "http request",
        "z": "f33b48a9db5775f9",
        "g": "60c3679c606b47f2",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 770,
        "y": 220,
        "wires": [
            [
                "1bf82c3ec50800c9"
            ]
        ]
    },
    {
        "id": "c7f4461a9273c688",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "7887c949a2fa716c",
        "name": "Set default",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet requests = [];\nlet id = 1;\n\nfor (let i = 0; i < rooms.length; i++) {\n\n  if (rooms[i].control === \"controlledByEventFromIcal\" || rooms[i].control === \"controlledBySchedule\") {\n    requests.push({\n      id: String(id),\n      method: \"POST\",\n      url: `/api/rest/v2/services/bacnet/local/objects/schedules/${rooms[i].scheduleID}`,\n      body: {\n        \"schedule-default\": 19,\n        description: `Room ${rooms[i].scheduleName}`\n      }\n    });\n\n    id++;\n  }\n}\n\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  },\n  icalToScheduleConf: icalToScheduleConf,\n  rooms: rooms\n}\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 100,
        "wires": [
            [
                "2e5ed530394f1b11"
            ]
        ]
    },
    {
        "id": "2e5ed530394f1b11",
        "type": "http request",
        "z": "f33b48a9db5775f9",
        "g": "7887c949a2fa716c",
        "name": "HTTP",
        "method": "use",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1130,
        "y": 100,
        "wires": [
            [
                "9ee6050374854ff5"
            ]
        ]
    },
    {
        "id": "ac485e91792c115d",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "c9670ab65e61517f",
        "name": "Debug controllerSetpoint",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\n\nlet requests = [];\nlet id = 12;\n\nfor (let i = 0; i < 10; i++) {\n\n  if (icalToScheduleConf.createScheduleAV) {\n    requests.push({\n      id: String(id),\n      method: \"POST\",\n      url: \"/api/rest/v2/services/bacnet/local/objects/add\",\n      body: {\n        \"object-type\": \"AnalogValue\",\n        \"instance-number\": id,\n        name: `controllerSetpoint-${id}`\n      }\n    });\n\n    id = id + 10;\n  }\n}\n\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  }\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 640,
        "wires": [
            [
                "99ad580cf038b510"
            ]
        ]
    },
    {
        "id": "99ad580cf038b510",
        "type": "http request",
        "z": "f33b48a9db5775f9",
        "g": "c9670ab65e61517f",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 850,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "7068cd7b280e6019",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "2ec2dd5006d1403d",
        "name": "Delete all bindings",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet requests = [];\nlet bindingList = [];\nlet id = 1;\n\nfor (let binding in msg.payload) {\n    bindingList.push(binding);\n}\n\nfor (let i = 0; i < bindingList.length; i++) {\n    requests.push({\n        id: String(id),\n        method: \"DELETE\",\n        url: `/api/rest/v2/services/events/bindings/${bindingList[i]}`\n    });\n\n    id++\n}\n\nreturn {\n    method: \"POST\",\n    url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n    headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n    payload: {\n        requests: requests\n    },\n    icalToScheduleConf: icalToScheduleConf,\n    rooms : rooms\n};\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 340,
        "wires": [
            [
                "d22d2eb2ad6d30cc"
            ]
        ]
    },
    {
        "id": "d22d2eb2ad6d30cc",
        "type": "http request",
        "z": "f33b48a9db5775f9",
        "g": "2ec2dd5006d1403d",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 770,
        "y": 340,
        "wires": [
            [
                "480cffc1c1df6580"
            ]
        ]
    },
    {
        "id": "2754b1683d01ad1e",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "2ec2dd5006d1403d",
        "name": "List Bindings",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nreturn {\n    method: \"GET\",\n    url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/services/events/bindings\",\n    headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n    icalToScheduleConf: icalToScheduleConf,\n    rooms : rooms\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 210,
        "y": 340,
        "wires": [
            [
                "5353e82dca8c4449"
            ]
        ]
    },
    {
        "id": "5353e82dca8c4449",
        "type": "http request",
        "z": "f33b48a9db5775f9",
        "g": "2ec2dd5006d1403d",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 410,
        "y": 340,
        "wires": [
            [
                "7068cd7b280e6019"
            ]
        ]
    },
    {
        "id": "b15e0162a3aa919f",
        "type": "http request",
        "z": "f33b48a9db5775f9",
        "g": "2ec2dd5006d1403d",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1130,
        "y": 340,
        "wires": [
            [
                "816890f28828b6e9"
            ]
        ]
    },
    {
        "id": "480cffc1c1df6580",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "2ec2dd5006d1403d",
        "name": "create Bindings",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\nlet deviceList = global.get(\"g_deviceList\");\n\nlet requests = [];\nlet id = 1;\nlet bindingSetNbr = 0;\n\nfor (let i = 0; i < rooms.length; i++) {\n  if (rooms[i].control === \"controlledByEventFromIcal\" || rooms[i].control === \"controlledBySchedule\" || rooms[i].control === \"controlledByConstant\") {\n    bindingSetNbr++;\n  }\n}\n\nnode.warn(`Creating ${bindingSetNbr} binding sets...`);\n\n/******  For Each room  ******/\nfor (let i = 0; i < rooms.length; i++) {\n  if (rooms[i].control === \"controlledByEventFromIcal\" || rooms[i].control === \"controlledBySchedule\" || rooms[i].control === \"controlledByConstant\") {\n    let deviceTypes = Object.keys(rooms[i].devices);\n    let scheduleName = rooms[i].scheduleName;\n    let scheduleID = rooms[i].scheduleID;\n    let scheduleAVinstanceNum = rooms[i].scheduleID + icalToScheduleConf.scheduleAVInstanceOffset;\n\n    /******  Each device type  ******/\n    for (let j = 0; j < deviceTypes.length; j++) {\n      let AVToBindName = rooms[i].devices[deviceTypes[j]].AVToBindName;\n      let AVToBindNameInstanceNumOffset = deviceList[deviceTypes[j]].bacnet.objects[rooms[i].devices[deviceTypes[j]].AVToBindName].instanceNum;\n      let offsetAV = deviceList[deviceTypes[j]].bacnet.offsetAV;\n\n      /******  Each device Num  ******/\n      for (let k = 0; k < rooms[i].devices[deviceTypes[j]].deviceNums.length; k++) {\n        let deviceNum = rooms[i].devices[deviceTypes[j]].deviceNums[k];\n        let AVToBindNameInstanceNum = deviceList[deviceTypes].bacnet.instanceRangeAV * deviceNum + AVToBindNameInstanceNumOffset + offsetAV;\n\n        requests.push({\n          id: String(id),\n          method: \"POST\",\n          url: `/api/rest/v2/services/events/bindings/binding_scheduleAV-${scheduleName}_${AVToBindName}-${AVToBindNameInstanceNum}`,\n          body: {\n            //key: \"Don't need this??\",\n            type: \"ControlElement\",\n            \"element-a\": `/services/bacnet/local/objects/analog-values/${icalToScheduleConf.scheduleAVInstanceOffset + scheduleID}`,\n            \"element-b\": `/services/bacnet/local/objects/analog-values/${AVToBindNameInstanceNum}`,\n            initialize: \"a-to-b\",\n            \"sync-a-to-b\": {\n              options: { priorities: true, \"write-priority\": 14, value: false, \"out-of-service\": true },\n              triggers: { \"1\": { key: \"1\", \"min-sync-time\": 0.0, type: \"OnChange\" } }\n            }\n          }\n        });\n        id++;\n      }\n    }\n  }\n}\n\n\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  },\n  icalToScheduleConf: icalToScheduleConf,\n  rooms: rooms\n}\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 960,
        "y": 340,
        "wires": [
            [
                "b15e0162a3aa919f"
            ]
        ]
    },
    {
        "id": "8ce9b18af3cebad6",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "7c1c45391173e445",
        "name": "Rooms",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\nlet controlledByEventFromIcalNbr = rooms.filter(element => element.control === \"controlledByEventFromIcal\").length;\n\nfunction createEvent() {\n    icalToScheduleConf.controlledByEventFromIcalNbr = controlledByEventFromIcalNbr;\n    icalToScheduleConf.startTimeUpdateSchedule = Date.now();\n    icalToScheduleConf.roomCounter = 0;\n\n    flow.set('sf_icalToScheduleConf', icalToScheduleConf);\n    for (let j = 0; j < rooms.length; j++) {\n        if (rooms[j].control === \"controlledByEventFromIcal\" ) {\n            node.send({\n                action: \"queue\",\n                payload: rooms[j]\n            });\n        }\n    }\n}\n\ncreateEvent();\nsetInterval(createEvent, icalToScheduleConf.timeBetweenScheduleUpdate * 1000); \n\n\n\n\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 200,
        "y": 500,
        "wires": [
            [
                "cf30b1fd186a52f4"
            ]
        ],
        "icon": "node-red/parser-json.svg"
    },
    {
        "id": "35675d0d71153dcf",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "7c1c45391173e445",
        "name": "Unqueue",
        "func": "let icalToScheduleConf = flow.get('sf_icalToScheduleConf');\n\nicalToScheduleConf.roomCounter++;\n\nif(icalToScheduleConf.roomCounter % icalToScheduleConf.controlledByEventFromIcalNbr == 0){\n    node.warn(`${icalToScheduleConf.controlledByEventFromIcalNbr} rooms processed in ${(Date.now() - icalToScheduleConf.startTimeUpdateSchedule) / 1000} s`);\n    node.status({ fill: \"green\", shape: \"dot\", text: `Process time : ${(Date.now() - icalToScheduleConf.startTimeUpdateSchedule) / 1000} s`});\n    icalToScheduleConf.startTimeUpdateSchedule =  Date.now();\n}\n\nflow.set('sf_icalToScheduleConf',icalToScheduleConf);\n\nreturn {\n    action : \"unqueue\"\n}\n/*\nmsg.action = \"unqueue\";\nreturn msg;\n*/",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "//flow.set('f_isControllerReady', true);\n",
        "finalize": "",
        "libs": [],
        "x": 1200,
        "y": 500,
        "wires": [
            [
                "cf30b1fd186a52f4"
            ]
        ]
    },
    {
        "id": "cf30b1fd186a52f4",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "7c1c45391173e445",
        "name": "Room Queue",
        "func": "let roomsQueue = flow.get('f_roomsQueue');\nconst maxQueueSize = 150;\n\n\n//node.status({ fill: \"green\", shape: \"dot\", text: `Queue size : ${roomsQueue.length} ` });\n//node.warn(roomsQueue);\n//node.warn(roomsQueue.length);\n\n////////////////// Queue ////////////////\nif (msg.action === \"queue\") {\n    if (roomsQueue.length >= maxQueueSize) {\n        //node.status({ fill: \"red\", shape: \"dot\", text: `Queue overflow (max : ${maxQueueSize})} ` });\n        node.error(`Room queue has exeeded its maximum size ${maxQueueSize}`);\n        return null;\n    }\n    else if (roomsQueue.length == 0 && flow.get('f_initialStart')) {\n        // First message, no need to queue.\n        flow.set('f_initialStart', false);\n        node.warn(\"Creating events for each room...\");\n        return {\n            \"url\": msg.payload.url,\n            \"timezone\": msg.payload.timeZone,\n            \"preview\": msg.payload.nbrDaysPreview,\n            \"roomConf\": msg.payload,\n            \"status\": { fill: \"green\", shape: \"dot\", text: `Room queue size : ${roomsQueue.length}` }\n\n        }\n    }\n    else {\n        //node.warn(\"Other message, Queue\");\n        roomsQueue.push(msg.payload);\n        flow.set('f_roomsQueue', roomsQueue);\n    }\n}\n\n////////////////// Unqueue ////////////////\nelse if (msg.action === \"unqueue\") {\n    if (roomsQueue.length === 0) {\n        flow.set('f_initialStart', true);\n        //node.warn(\"Unqueue with lenght == 0, initialStart = true\");\n    }\n    else {\n        let newRoom = roomsQueue.shift();\n        flow.set('f_roomsQueue', roomsQueue);\n        //node.warn(\"Unqueue\");\n        return {\n            \"url\": newRoom.url,\n            \"timezone\": newRoom.timeZone,\n            \"preview\": newRoom.nbrDaysPreview,\n            \"roomConf\": newRoom,\n            \"status\": { fill: \"green\", shape: \"dot\", text: `Room queue size : ${roomsQueue.length}` }\n        }\n    }\n}\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "let roomsQueue = [];\nflow.set('f_roomsQueue', roomsQueue);\n\nlet initialStart = true;\nflow.set('f_initialStart', initialStart);\n",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 500,
        "wires": [
            [
                "e882045259b5aaa0"
            ]
        ]
    },
    {
        "id": "0694d54d36faf630",
        "type": "http request",
        "z": "f33b48a9db5775f9",
        "g": "7c1c45391173e445",
        "name": "HTTP",
        "method": "use",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1030,
        "y": 460,
        "wires": [
            [
                "35675d0d71153dcf"
            ]
        ]
    },
    {
        "id": "e882045259b5aaa0",
        "type": "ical-upcoming",
        "z": "f33b48a9db5775f9",
        "g": "7c1c45391173e445",
        "confignode": "f73555ac13078ac6",
        "timeout": "",
        "timeoutUnits": "seconds",
        "cron": "",
        "name": "Get Room calendar",
        "offsettype": "",
        "offset": "",
        "offsetUnitstype": "",
        "offsetUnits": "",
        "eventtypes": "events",
        "eventtypestype": "eventtypes",
        "calendar": "",
        "calendartype": "str",
        "triggertype": "trigger",
        "trigger": "always",
        "timezone": "",
        "timezonetype": "str",
        "dateformat": "{ \"timeStyle\": \"short\", \"dateStyle\": \"short\" }",
        "dateformattype": "json",
        "language": "en",
        "languagetype": "language",
        "filterProperty": "summary",
        "filterPropertytype": "filterProperty",
        "filterOperator": "between",
        "filterOperatortype": "filterOperator",
        "filtertype": "str",
        "filter2type": "str",
        "filter2": "",
        "filter": "",
        "checkall": false,
        "endpreview": "",
        "endpreviewUnits": "",
        "previewtype": "num",
        "preview": "20",
        "previewUnitstype": "previewUnits",
        "previewUnits": "days",
        "pastviewtype": "num",
        "pastview": "0",
        "pastviewUnits": "days",
        "pastviewUnitstype": "pastviewUnits",
        "x": 630,
        "y": 500,
        "wires": [
            [
                "fa8debb3d63f3fd3"
            ]
        ]
    },
    {
        "id": "fa8debb3d63f3fd3",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "7c1c45391173e445",
        "name": "Create events",
        "func": "let icalToScheduleConf = flow.get('sf_icalToScheduleConf');\nlet roomConf = msg.roomConf;\nlet eventNumber = msg.total;\nlet events = [/* {eventStart : Date , eventEnd : Date,, ...}*/];  // List of events to create.\nlet httpRequestEventList = {};\n\n///////////////////////////////////////////////////////////////////////\n/////////////////     Events manipulation  ////////////////////////////\n///////////////////////////////////////////////////////////////////////\n\nfunction eventCreation() {\n  for (let i = 0; i < eventNumber; i++) {\n    // Event are discarded according to their \"event description\" in the ics file.\n    if (!icalToScheduleConf.eventsToDiscard.some(discardStr => msg.payload[i].description?.includes(discardStr))) {\n\n      //////////  groupEvents == true   //////////////\n      if (icalToScheduleConf.groupEvents) {\n        let msgEventStart = new Date(msg.payload[i].eventStart);\n        let msgEventEnd = new Date(msg.payload[i].eventEnd);\n\n        // Check if an event with same year-date-time already exist in events[].\n        const idx = events.findIndex(evt => {\n          return (\n            msgEventStart.getDate() === evt.eventStart.getDate() &&\n            msgEventEnd.getMonth() === evt.eventStart.getMonth() &&\n            msgEventEnd.getFullYear() === evt.eventStart.getFullYear()\n          );\n        });\n\n        if (idx != -1) {    // Event with same year-date-time already exits\n\n          if (msgEventStart < events[idx].eventStart) events[idx].eventStart = msgEventStart; // Update start time\n          if (msgEventEnd > events[idx].eventEnd) events[idx].eventEnd = msgEventEnd;         // Update end time\n          //node.warn(\"idx : \" + idx);\n          //node.warn(events);\n        }\n        else {               // Add a new event\n          //node.warn(\"Event added\");\n          events.push(msg.payload[i]);\n          events.at(-1).eventStart = new Date(events.at(-1).eventStart);  // at(-1) = last index\n          events.at(-1).eventEnd = new Date(events.at(-1).eventEnd);      // at(-1) = last index\n          events.at(-1).summary = \"Merged Events\";\n          //node.warn(events);\n        }\n      }\n\n      //////////  groupEvents == false   //////////////\n      else {\n        //node.warn(\"Event added\");\n        events.push(msg.payload[i]);\n        events.at(-1).eventStart = new Date(events.at(-1).eventStart);  // at(-1) = last index\n        events.at(-1).eventEnd = new Date(events.at(-1).eventEnd);      // at(-1) = last index\n      }\n    }\n    else {\n      //node.warn(`Event ${i} : ${msg.payload[i].summary} is discarded`);\n    }\n  }\n\n  // node.warn(events);\n\n\n  ///////////////////////////////////////////////////////////////////////\n  /////////////////    HTTP Request Creation   //////////////////////////\n  ///////////////////////////////////////////////////////////////////////\n  let eventID = 1;\n\n  for (let i = 0; i < events.length; i++) {\n\n    let start = new Date(events[i].eventStart);\n    let end = new Date(events[i].eventEnd);\n\n    // Rule 1 : discard events shorter than 30 minutes\n    const durationMinutes = (end.getTime() - start.getTime()) / (1000 * 60);\n    if (durationMinutes < icalToScheduleConf.minimumSlotDuration) {\n      node.warn(`Event ${i} \"${events[i].summary}\" discarded (duration < ${icalToScheduleConf.minimumSlotDuration} min).`);\n      continue;\n    }\n\n    // Adjust the time with timeOffsetBeforeStart and timeOffsetBeforeEnd\n    if (icalToScheduleConf.groupEvents) {\n      const midnight = new Date(start);\n      midnight.setHours(0, 0, 0, 0);\n\n      start.setMinutes(start.getMinutes() - roomConf.timeOffsetBeforeStart);\n      end.setMinutes(end.getMinutes() - roomConf.timeOffsetBeforeEnd);\n\n      // Rule 2 : Clamp start to midnight if it went before 00:00\n      if (start < midnight) {\n        start = new Date(midnight);\n        node.warn(`Event ${i} \"${events[i].summary}\" clamp to midnight.`);\n      }\n\n      // Rule 3 : ensure start < end.\n      if (start >= end) {\n        node.warn(`Event ${i} \"${events[i].summary}\" discarded  (start >= end).`);\n        continue;\n      }\n    }\n\n\n    // Create Event request\n    let eventObject = {\n      [eventID]: {\n        \"event-priority\": 16,\n        period: {\n          date: {\n            month: start.getMonth() + 1,\n            year: start.getFullYear(),\n            \"day-of-month\": start.getDate()\n          },\n          type: \"Date\"\n        },\n        name: events[i].summary,\n        transitions: {\n          1: {\n            time: start.toLocaleTimeString(\"fr-FR\", { timeZone: icalToScheduleConf.timeZone }),\n            value: roomConf.tempOccupied,\n            key: \"1\"\n          },\n          2: {\n            time: end.toLocaleTimeString(\"fr-FR\", { timeZone: icalToScheduleConf.timeZone }),\n            value: null,\n            key: \"2\"\n          }\n        },\n        key: String(eventID)\n      }\n    };\n    eventID++;\n    httpRequestEventList = { ...httpRequestEventList, ...eventObject };   // Merge with the previous object\n  }\n\n  let request = {\n    \"method\": \"POST\",\n    \"url\": `https://${icalToScheduleConf.controllerIPAddress}/api/rest/v2/services/bacnet/local/objects/schedules/${roomConf.scheduleID}`,\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n    \"payload\": {\n      \"special-events\": httpRequestEventList,\n      \"weekly-schedule\" :  roomConf.weekly  ,\n      \"object-name\": roomConf.scheduleName,\n      \"schedule-default\": roomConf.tempUnoccupied\n    },\n    \"roomConf\": msg.roomConf\n  };\n\n  return request;\n}\n\n\nif (!msg.error) {\n  //node.warn(\"No error... continue\");\n  return [eventCreation(), null];\n} else {\n  //node.warn(\"Error skip\");\n  return [null, msg];\n}",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 860,
        "y": 500,
        "wires": [
            [
                "0694d54d36faf630"
            ],
            [
                "35675d0d71153dcf"
            ]
        ]
    },
    {
        "id": "9ee6050374854ff5",
        "type": "link out",
        "z": "f33b48a9db5775f9",
        "g": "7887c949a2fa716c",
        "name": "schedule out",
        "mode": "link",
        "links": [
            "e48cab65133c69e5"
        ],
        "x": 1255,
        "y": 100,
        "wires": []
    },
    {
        "id": "06c3f20432e068ed",
        "type": "link out",
        "z": "f33b48a9db5775f9",
        "g": "60c3679c606b47f2",
        "name": "scheduleAV out",
        "mode": "link",
        "links": [
            "baaab3900d810b91"
        ],
        "x": 1255,
        "y": 220,
        "wires": []
    },
    {
        "id": "816890f28828b6e9",
        "type": "link out",
        "z": "f33b48a9db5775f9",
        "g": "2ec2dd5006d1403d",
        "name": "bindings out",
        "mode": "link",
        "links": [
            "a993888d171b5dc1"
        ],
        "x": 1255,
        "y": 340,
        "wires": []
    },
    {
        "id": "e48cab65133c69e5",
        "type": "link in",
        "z": "f33b48a9db5775f9",
        "name": "scheduleAV in",
        "links": [
            "9ee6050374854ff5"
        ],
        "x": 55,
        "y": 220,
        "wires": [
            [
                "a6e3cfb05519d183"
            ]
        ]
    },
    {
        "id": "baaab3900d810b91",
        "type": "link in",
        "z": "f33b48a9db5775f9",
        "name": "bindings in",
        "links": [
            "06c3f20432e068ed"
        ],
        "x": 55,
        "y": 340,
        "wires": [
            [
                "2754b1683d01ad1e"
            ]
        ]
    },
    {
        "id": "a993888d171b5dc1",
        "type": "link in",
        "z": "f33b48a9db5775f9",
        "name": "link in 1",
        "links": [
            "816890f28828b6e9"
        ],
        "x": 55,
        "y": 500,
        "wires": [
            [
                "8ce9b18af3cebad6"
            ]
        ]
    },
    {
        "id": "1bf82c3ec50800c9",
        "type": "function",
        "z": "f33b48a9db5775f9",
        "g": "60c3679c606b47f2",
        "name": "Set default",
        "func": "let icalToScheduleConf = msg.icalToScheduleConf;\nlet rooms = msg.rooms;\n\nlet requests = [];\nlet id = 1;\n\nfor (let i = 0; i < rooms.length; i++) {\n\n  //if (rooms[i].control === \"controlledByConstant\") {\n    requests.push({\n      id: String(id),\n      method: \"POST\",\n      url: `/api/rest/v2/services/bacnet/local/objects/analog-values/${rooms[i].scheduleID + icalToScheduleConf.scheduleAVInstanceOffset}`,\n      body: {\n        \"default-value\": rooms[i].tempOccupied\n      }\n    });\n\n    id++;\n  }\n//}\n\n\nreturn {\n  method: \"POST\",\n  url: \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n  headers: { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n  payload: {\n    requests: requests\n  },\n  icalToScheduleConf: icalToScheduleConf,\n  rooms: rooms\n}\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 220,
        "wires": [
            [
                "6a950ca5a01f3b41"
            ]
        ]
    },
    {
        "id": "6a950ca5a01f3b41",
        "type": "http request",
        "z": "f33b48a9db5775f9",
        "g": "60c3679c606b47f2",
        "name": "HTTP",
        "method": "use",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1130,
        "y": 220,
        "wires": [
            [
                "06c3f20432e068ed"
            ]
        ]
    },
    {
        "id": "e992fac85de69dcc",
        "type": "comment",
        "z": "f33b48a9db5775f9",
        "g": "7c1c45391173e445",
        "name": "",
        "info": "In case of error when getting the ical, the event creation process is skipped.",
        "x": 1040,
        "y": 500,
        "wires": []
    },
    {
        "id": "2ec2dd5006d1403d",
        "type": "group",
        "z": "f33b48a9db5775f9",
        "name": "Bindings",
        "style": {
            "label": true,
            "color": "#000000",
            "fill": "#ffbfbf",
            "label-position": "n"
        },
        "nodes": [
            "7068cd7b280e6019",
            "d22d2eb2ad6d30cc",
            "2754b1683d01ad1e",
            "5353e82dca8c4449",
            "b15e0162a3aa919f",
            "480cffc1c1df6580",
            "816890f28828b6e9"
        ],
        "x": 114,
        "y": 299,
        "w": 1182,
        "h": 82
    },
    {
        "id": "7887c949a2fa716c",
        "type": "group",
        "z": "f33b48a9db5775f9",
        "name": "Schedule",
        "style": {
            "fill": "#ffefbf",
            "label": true,
            "label-position": "n",
            "color": "#000000"
        },
        "nodes": [
            "0a22dbefe945e1a5",
            "eff1beb6101e98b5",
            "d2b052b0dded9737",
            "257e24ab3c5da25d",
            "c7f4461a9273c688",
            "2e5ed530394f1b11",
            "9ee6050374854ff5"
        ],
        "x": 114,
        "y": 59,
        "w": 1182,
        "h": 82
    },
    {
        "id": "60c3679c606b47f2",
        "type": "group",
        "z": "f33b48a9db5775f9",
        "name": "ScheduleAV",
        "style": {
            "fill": "#e3f3d3",
            "label": true,
            "label-position": "n",
            "color": "#000000"
        },
        "nodes": [
            "b832441d55badea7",
            "a6e3cfb05519d183",
            "9d9893690a03cd25",
            "8114bf7d0dc66b62",
            "06c3f20432e068ed",
            "1bf82c3ec50800c9",
            "6a950ca5a01f3b41"
        ],
        "x": 114,
        "y": 179,
        "w": 1182,
        "h": 82
    },
    {
        "id": "7c1c45391173e445",
        "type": "group",
        "z": "f33b48a9db5775f9",
        "name": "Create events",
        "style": {
            "fill": "#bfdbef",
            "label": true,
            "label-position": "n",
            "color": "#000000"
        },
        "nodes": [
            "8ce9b18af3cebad6",
            "35675d0d71153dcf",
            "cf30b1fd186a52f4",
            "0694d54d36faf630",
            "e882045259b5aaa0",
            "fa8debb3d63f3fd3",
            "e992fac85de69dcc"
        ],
        "x": 114,
        "y": 419,
        "w": 1172,
        "h": 122
    },
    {
        "id": "c9670ab65e61517f",
        "type": "group",
        "z": "f33b48a9db5775f9",
        "name": "For DEBUG",
        "style": {
            "label": true,
            "label-position": "n",
            "color": "#000000"
        },
        "nodes": [
            "ac485e91792c115d",
            "99ad580cf038b510"
        ],
        "x": 474,
        "y": 599,
        "w": 452,
        "h": 82
    },
    {
        "id": "f73555ac13078ac6",
        "type": "ical-config",
        "url": "",
        "caldav": "",
        "caltype": "ical",
        "name": "",
        "replacedates": false,
        "usecache": false,
        "username": "",
        "password": "",
        "experimental": false,
        "calendar": "",
        "pastWeeks": "0",
        "futureWeeks": "4"
    },
    {
        "id": "7c27a8c8ec69277d",
        "type": "tab",
        "label": "Ical to Schedule",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "cc921d23986230be",
        "type": "group",
        "z": "7c27a8c8ec69277d",
        "name": "For DEBUG",
        "style": {
            "label": true,
            "stroke": "#a4a4a4",
            "label-position": "n",
            "color": "#000000",
            "fill": "#e3f3d3"
        },
        "nodes": [
            "b2e15c96251c0167",
            "b59bd72bdeec5e96",
            "08ceecac32b48a7c",
            "3cda8c0c5dedfc71",
            "531b4fc2ca0f2a6f",
            "f7240e0a6a6f8b0e",
            "1f2ac394bda1cc0b",
            "20f1513c18662c8b",
            "02cf92fb5a649eb2",
            "2db9716c2bf9c19e",
            "e173306bea247783",
            "af277efbdafc5fe9",
            "5a6aef228d3f3021",
            "dd46e49040b2c855",
            "4c598606ae5d455f",
            "4b51466b3b124479",
            "6d0aadf93bcb3dcb",
            "4eb11c8599185bf8",
            "e4d83857f1e66295",
            "4e6ebaf5965c80ed",
            "ea2f4af98df53c6f",
            "e1be88ea5ff19887",
            "d298eee68a586a0c",
            "393d2de1a3dd4d28",
            "013c3b4d2ad370cb",
            "2fbfc9010c61fc0b",
            "6f466eea47a546ea",
            "cead8873ee8b73e1",
            "981fe7f22dccfc11",
            "1fa601afaa8cb01f"
        ],
        "x": 134,
        "y": 519,
        "w": 992,
        "h": 322
    },
    {
        "id": "e59f934448fe6324",
        "type": "group",
        "z": "7c27a8c8ec69277d",
        "name": "IcalToSchedule",
        "style": {
            "fill": "#bfdbef",
            "label": true,
            "label-position": "n",
            "color": "#000000"
        },
        "nodes": [
            "9f3484831c9418f4",
            "092331c005116385",
            "4b68464aac34045b",
            "d8cdbaee723651d1",
            "50d907eb2f5616ca"
        ],
        "x": 194,
        "y": 39,
        "w": 872,
        "h": 202
    },
    {
        "id": "717b28d528948e6a",
        "type": "group",
        "z": "7c27a8c8ec69277d",
        "name": "Onboard GTC",
        "style": {
            "fill": "#ffefbf",
            "label": true,
            "label-position": "n",
            "color": "#000000"
        },
        "nodes": [
            "49235db22d809404",
            "ad4e81c813c05d28",
            "8ec2a85ec2b17921",
            "a7a1f5b6391189e3",
            "f46ec136defc086f",
            "dde8974e1851971f",
            "230c902f8db1e63d"
        ],
        "x": 184,
        "y": 299,
        "w": 882,
        "h": 142
    },
    {
        "id": "9f3484831c9418f4",
        "type": "function",
        "z": "7c27a8c8ec69277d",
        "g": "e59f934448fe6324",
        "name": "TO CONFIGURE",
        "func": "//////////////////////////////////////////////\n//////////////// TO CONFIGURE ////////////////\n//////////////////////////////////////////////\n\nconst printMissingDevice = false;\nconst defaultControl = \"controlledByEventFromIcal\"; //  controlledByEventFromIcal, controlledBySchedule, controlledByConstant, inactive\n\n// 1. Create BACnet Schedule\nconst timeBetweenScheduleUpdate = 60 * 60;    // Seconds, Time to refresh calendar events\nconst scheduleInstanceRange = [0, 50];\nconst groupEvents = true;               // Group events in 1 event/day\nconst timeZone = 'Europe/Paris';        // What are the other options ?\nconst eventsToDiscard = [\"SOBRIETE ENERGETIQUE\"]; // all events that content this string in their description will be ignored\nconst defaultTempOccupied = 20;\nconst defaultTempUnoccupied = 15;\nconst defaultTimeOffsetBeforeStart = 120;            // in mins\nconst defaultTimeOffsetBeforeEnd = 30;              // in mins\nconst defaultNbrDaysPreview = 10;                   // Days, max is defined in the \"Get Room Calendar\" node.\nconst defaultAddSuffixToAdeURL = true;\nconst minimumSlotDuration = 0;                     // in mins\nconst defaultWeekly = {\n    monday: { transitions: {} },\n    tuesday: { transitions: {} },\n    wednesday: { transitions: {} },\n    thursday: { transitions: {} },\n    friday: {\n        transitions: {\n            \"1\": { time: \"15:00:00.00\", value: 7, key: \"1\" },\n            \"2\": { time: \"23:59:59.00\", value: null, key: \"2\" }\n        }\n    },\n    saturday: {\n        transitions: {\n            \"1\": { time: \"00:00:00.00\", value: 7, key: \"1\" },\n            \"2\": { time: \"23:59:59.00\", value: null, key: \"2\" }\n        }\n    },\n    sunday: {\n        transitions: {\n            \"1\": { time: \"00:00:00.00\", value: 7, key: \"1\" },\n            \"2\": { time: \"21:00:00.00\", value: null, key: \"2\" }\n        }\n    }\n}\n\n// 2. Analog value for each schedule\nconst scheduleAVInstanceOffset = 10000;  //  The starting instance of theses values\nconst timeBetweenScheduleAVUpdate = 30; //   Seconds\n\n// Info : \n// * minimumSlotDuration is only checked when groupEvents = false.\n// * defaultTimeOffsetBeforeStart and defaultTimeOffsetBeforeEnd are only applied when groupEvents = true.\n// * eventsToDiscard is always appliead whatever groupsEvents value.\n// * control : \n//          controlledByEventFromIcal : createSchedule, add event, create scheduleAV, create Bindings.\n//          controlledBySchedule :      createSchedule,            create scheduleAV, create Bindings.\n//          controlledByConstant :                                 create scheduleAV, create Bindings.\n//          Inactive : Does nothing.\n\n\n/////////////////////////////\n///// Rooms Informations  ///\n/////////////////////////////\n\n/* Room Template \n{\n    // Mandatory //\n    \"scheduleName\": \"roomName0\",\n    \"devices\": { \"device-1\": { \"deviceNums\": [1, 2, 3], \"AVToBindName\": \"controllerSetpoint\" } },\n    \"url\": 'https://ade-usmb-ro.grenet.fr/jsp/custom/modules/plannings/direct_cal.jsp?data=b5cfb898a9c27be94975c12c6eb30e9233bdfae22c1b52e2cd88eb944acf5364c69e3e5921f4a6ebe36e93ea9658a08f,1&resources=1480&projectId=5&calType=ical&lastDate=2042-08-14',\n    \n    // Optionnal, if not specified the default value will be applied //\n    \"control\": [ controlledByEventFromIcal, controlledBySchedule, controlledByConstant, inactive ]\n    \"weekly\" : defaultWeekly,\n    \"nbrDaysPreview\" : defaultNbrDaysPreview,\n    \"tempOccupied\": defaultTempOccupied,\n    \"tempUnoccupied\": defaultTempUnoccupied,\n    \"timeOffsetBeforeStart\": defaultTimeOffsetBeforeStart,\n    \"timeOffsetBeforeEnd\": defaultTimeOffsetBeforeEnd,\n    \"addSuffixToAdeURL\" : defaultAddSuffixToAdeURL\n*/\n\n\nlet rooms = [\n\n]\n\n\n\n\n/////////////////////////////////////////////////\n/////////////// DO NOT MODIFY ///////////////////\n/////////////////////////////////////////////////\nconst controlSet = [\"controlledByEventFromIcal\", \"controlledBySchedule\", \"controlledByConstant\", \"inactive\"];\nconst deviceList = global.get('g_deviceList');    // From LoRaBAC node\n\nif (rooms.length === 0) {\n    node.error(`No Room configuration available`);\n    node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n    return null;\n}\n\nif (!deviceList) {\n    node.error(`Device List missing from LoRaBAC node`);\n    node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n    return null;\n}\n\nfor (let device in deviceList) {\n    if (Object.keys(deviceList).some(dev => deviceList[dev].controller.ipAddress != deviceList[device].controller.ipAddress)) {\n        node.error(`Controller IP Address are not all the same in device list`);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n}\n\nif (scheduleInstanceRange[0] > scheduleInstanceRange[1] || scheduleInstanceRange.length !== 2) {\n    node.error(`Wrong Schedule instance range`);\n    node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n    return null;\n}\n\nif (Object.keys(rooms).length > (scheduleInstanceRange[1] - scheduleInstanceRange[0] + 1)) {\n    node.error(`Too many rooms, increase Schedule Instance Range`);\n    node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n    return null;\n}\n\n\nconst scheduleNames = rooms.map(room => room.scheduleName);\nif (new Set(scheduleNames).size !== scheduleNames.length) {\n    node.error(`Duplicate ScheduleName in room configuration`);\n    node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n    return null;\n}\n\nlet scheduleID = 0;\nlet deviceNums = {};\n\n\nfor (let room in rooms) {\n\n    rooms[room].scheduleID = scheduleID++;\n\n    if (!rooms[room].hasOwnProperty(\"scheduleName\")) {\n        node.error(`One room  has no scheduleName in room configuration`);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"devices\")) {\n        node.error(`Room  ${rooms[room].scheduleName} has no devices`);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"control\")) {\n        rooms[room].control = defaultControl;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"weekly\")) {\n        rooms[room].weekly = defaultWeekly;\n    }\n\n    if (!controlSet.some(element => element == rooms[room].control)) {\n        node.error(`Room  ${rooms[room].scheduleName} control mode doesn't exist`);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"url\") && rooms[room].control === \"controlledByEventFromIcal\") {\n        node.error(`Room  ${rooms[room].scheduleName} has no url`);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n\n    if (!rooms[room].url && rooms[room].control === \"controlledByEventFromIcal\") {\n        node.error(`url falsy value for ${rooms[room].scheduleName}`);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n\n    if (rooms[room].scheduleID > scheduleInstanceRange[1]) {\n        node.error(`Room ${rooms[room].scheduleName} has a scheduleID over the allocated range (${scheduleInstanceRange[1]}) `);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n\n\n\n    for (let device in rooms[room].devices) {\n        deviceNums[device] = (deviceNums[device] || []).concat(rooms[room].devices[device].deviceNums);\n        //node.warn(deviceNums);\n\n        if (!Object.keys(deviceList).some(deviceType => deviceType == device)) {\n            node.error(`Room ${rooms[room].scheduleName} has a device type that doesn't belong to the device list`);\n            node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n            return null;\n        }\n\n        if (!Object.keys(deviceList[device].bacnet.objects).some(object => object == rooms[room].devices[device].AVToBindName)) {\n            node.error(`Room ${rooms[room].scheduleName} has a device with AVToBindName (${rooms[room].devices[device].AVToBindName}) that doesn't exist in the device List`);\n            node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n            return null;\n        } else if (deviceList[device].bacnet.objects[rooms[room].devices[device].AVToBindName].dataDirection !== \"downlink\") {\n            node.error(`${rooms[room].devices[device].AVToBindName} can't be an AVToBindName because it is not a downlink object in ${device}`);\n            node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n            return null;\n\n        }\n        rooms[room].devices[device].deviceNums\n        if (rooms[room].devices[device].deviceNums.some(numDevice => numDevice > deviceList[device].identity.maxDevNum)) {\n            node.error(`Room ${rooms[room].scheduleName} has a device number that exceed the maximum (${deviceList[device].identity.maxDevNum}) for device type ${device}`);\n            node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n            return null;\n        }\n\n    }\n\n    if (!rooms[room].hasOwnProperty(\"timeZone\")) {\n        rooms[room].timeZone = timeZone;\n    }\n    if (!rooms[room].timeZone) {\n        node.error(`timeZone falsy value for ${rooms[room].scheduleName} `);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"tempUnoccupied\")) {\n        rooms[room].tempUnoccupied = defaultTempUnoccupied;\n    }\n    if (!rooms[room].tempUnoccupied) {\n        node.error(`tempUnoccupied falsy value : ${rooms[room].tempUnoccupied} `);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"tempOccupied\")) {\n        rooms[room].tempOccupied = defaultTempOccupied;\n    }\n    if (!rooms[room].tempOccupied) {\n        node.error(`tempOccupied falsy value : ${rooms[room].tempOccupied} `);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"timeOffsetBeforeStart\")) {\n        rooms[room].timeOffsetBeforeStart = defaultTimeOffsetBeforeStart;\n    }\n    if (!rooms[room].timeOffsetBeforeStart) {\n        node.error(`timeOffsetBeforeStart falsy value : ${rooms[room].timeOffsetBeforeStart} `);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"timeOffsetBeforeEnd\")) {\n        rooms[room].timeOffsetBeforeEnd = defaultTimeOffsetBeforeEnd;\n    }\n    if (!rooms[room].timeOffsetBeforeEnd) {\n        node.error(`timeOffsetBeforeEnd falsy value : ${rooms[room].timeOffsetBeforeEnd} `);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"nbrDaysPreview\")) {\n        rooms[room].nbrDaysPreview = defaultNbrDaysPreview;\n    }\n    if (!rooms[room].nbrDaysPreview) {\n        node.error(`nbrDaysPreview falsy value : ${rooms[room].nbrDaysPreview} `);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n\n    if (!rooms[room].hasOwnProperty(\"addSuffixToAdeURL\")) {\n        rooms[room].addSuffixToAdeURL = defaultAddSuffixToAdeURL;\n    }\n\n\n    if (rooms[room].addSuffixToAdeURL && rooms[room].control === \"controlledByEventFromIcal\") {\n        const date = new Date();\n        date.setDate(date.getDate() + rooms[room].nbrDaysPreview);\n        let adeSuffixe = date.toISOString().slice(0, 10)\n        if (rooms[room].url.includes(\"&lastDate\")) {\n            rooms[room].url = rooms[room].url.replace(/&lastDate=\\d{4}-\\d{2}-\\d{2}/, `&lastDate=${adeSuffixe}`);\n        }\n        else {\n            rooms[room].url += `&lastDate=${adeSuffixe}`;\n        }\n    }\n}\n\n\nlet missingDev = \"INFO : Missing devices : \";\nfor (let device in deviceNums) {\n    const deviceNumSet = new Set(deviceNums[device]);\n\n    if (deviceNumSet.size !== deviceNums[device].length) {\n        node.error(`${device} as duplicate device Numbers in the configuration`);\n        node.status({ fill: \"red\", shape: \"dot\", text: `Configuration error` });\n        return null;\n    }\n\n    missingDev += device + \" : \";\n    for (let i = 1; i < Math.max(...deviceNumSet); i++) {\n        if (!Array.from(deviceNumSet).some(element => element == i)) {\n            missingDev += i + \", \";\n        }\n    }\n}\n\nif (printMissingDevice) {\n    node.warn(missingDev);\n}\n\n\nnode.status({ fill: \"green\", shape: \"dot\", text: `Configuration OK` });\n\nfor (let device in deviceList) {\n    const buffer = Buffer.from(deviceList[device].controller.login + ':' + deviceList[device].controller.password);\n    deviceList[device].controller.httpAuthentication = \"Basic \" + buffer.toString('base64');\n}\n\n// Store variables\n\nlet icalToScheduleConf = {\n    controllerIPAddress: deviceList[Object.keys(deviceList)[0]].controller.ipAddress,\n    controllerLogin: deviceList[Object.keys(deviceList)[0]].controller.login,\n    controllerPassword: deviceList[Object.keys(deviceList)[0]].controller.password,\n    httpAuthentication: deviceList[Object.keys(deviceList)[0]].controller.httpAuthentication,\n    timeBetweenScheduleUpdate: timeBetweenScheduleUpdate,\n    timeBetweenScheduleAVUpdate: timeBetweenScheduleAVUpdate,\n    defaultTimeOffsetBeforeStart: defaultTimeOffsetBeforeStart,     // To remove ?\n    defaultTimeOffsetBeforeEnd: defaultTimeOffsetBeforeEnd,         // To remove ?\n    scheduleInstanceRange: scheduleInstanceRange,\n    groupEvents: groupEvents,\n    timeZone: timeZone,                                             // To remove ?\n    eventsToDiscard: eventsToDiscard,\n    scheduleAVInstanceOffset: scheduleAVInstanceOffset,\n    minimumSlotDuration: minimumSlotDuration,\n}\n\nflow.set('f_icalToScheduleConf', icalToScheduleConf); // For Debug section only (to reach the BMS IP address)\nflow.set('f_rooms', rooms);\n\nreturn msg = {\n    icalToScheduleConf: icalToScheduleConf,\n    rooms: rooms\n};\n\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 140,
        "wires": [
            [
                "50d907eb2f5616ca",
                "4b68464aac34045b",
                "d8cdbaee723651d1"
            ]
        ],
        "icon": "node-red/cog.svg"
    },
    {
        "id": "092331c005116385",
        "type": "inject",
        "z": "7c27a8c8ec69277d",
        "g": "e59f934448fe6324",
        "name": "Start after 0.5s",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0.5",
        "topic": "",
        "x": 320,
        "y": 140,
        "wires": [
            [
                "9f3484831c9418f4"
            ]
        ]
    },
    {
        "id": "b2e15c96251c0167",
        "type": "inject",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 195,
        "y": 560,
        "wires": [
            [
                "b59bd72bdeec5e96"
            ]
        ],
        "l": false
    },
    {
        "id": "b59bd72bdeec5e96",
        "type": "function",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "List Schedules",
        "func": "let icalToScheduleConf = flow.get('f_icalToScheduleConf');\n\nreturn {\n    \"method\": \"GET\",\n    \"url\": \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/services/bacnet/local/objects/schedules\",\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" }\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 560,
        "wires": [
            [
                "08ceecac32b48a7c"
            ]
        ]
    },
    {
        "id": "08ceecac32b48a7c",
        "type": "http request",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 500,
        "y": 560,
        "wires": [
            [
                "3cda8c0c5dedfc71"
            ]
        ]
    },
    {
        "id": "3cda8c0c5dedfc71",
        "type": "debug",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "Schedules",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1000,
        "y": 560,
        "wires": []
    },
    {
        "id": "531b4fc2ca0f2a6f",
        "type": "inject",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 195,
        "y": 600,
        "wires": [
            [
                "f7240e0a6a6f8b0e"
            ]
        ],
        "l": false
    },
    {
        "id": "f7240e0a6a6f8b0e",
        "type": "function",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "List Bindings",
        "func": "let icalToScheduleConf = flow.get('f_icalToScheduleConf');\n\nreturn {\n    \"method\": \"GET\",\n    \"url\": \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/services/events/bindings\",\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication , \"Content-Type\": \"application/json\" }\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 600,
        "wires": [
            [
                "1f2ac394bda1cc0b"
            ]
        ]
    },
    {
        "id": "1f2ac394bda1cc0b",
        "type": "http request",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 500,
        "y": 600,
        "wires": [
            [
                "20f1513c18662c8b"
            ]
        ]
    },
    {
        "id": "20f1513c18662c8b",
        "type": "debug",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "Bindings",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 990,
        "y": 600,
        "wires": []
    },
    {
        "id": "02cf92fb5a649eb2",
        "type": "function",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "Delete all bindings",
        "func": "let icalToScheduleConf = flow.get('f_icalToScheduleConf');\n\nlet requests = [];\nlet bindingList = [];\nlet id = 1;\n\nfor(let binding in msg.payload){\n    bindingList.push(binding);\n}\n\n\nfor (let i = 0 ; i < bindingList.length ; i++) {\nrequests.push(JSON.parse(`{ \"id\": \"${id}\", \"method\": \"DELETE\", \"url\": \"/api/rest/v2/services/events/bindings/${bindingList[i]}\"}`)); //Bindings name\n    id++\n}\n\n\nreturn {\n    \"method\": \"POST\",\n    \"url\": \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/batch\",\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication , \"Content-Type\": \"application/json\" },\n    \"payload\": {\n        \"requests\": requests\n    }\n};\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 640,
        "wires": [
            [
                "af277efbdafc5fe9"
            ]
        ]
    },
    {
        "id": "2db9716c2bf9c19e",
        "type": "inject",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 195,
        "y": 640,
        "wires": [
            [
                "5a6aef228d3f3021"
            ]
        ],
        "l": false
    },
    {
        "id": "e173306bea247783",
        "type": "debug",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "Bindings",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 990,
        "y": 640,
        "wires": []
    },
    {
        "id": "af277efbdafc5fe9",
        "type": "http request",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 850,
        "y": 640,
        "wires": [
            [
                "e173306bea247783"
            ]
        ]
    },
    {
        "id": "5a6aef228d3f3021",
        "type": "function",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "List Bindings",
        "func": "let icalToScheduleConf = flow.get('f_icalToScheduleConf');\n\nreturn {\n    \"method\": \"GET\",\n    \"url\": \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/services/events/bindings\",\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication , \"Content-Type\": \"application/json\" }\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 640,
        "wires": [
            [
                "dd46e49040b2c855"
            ]
        ]
    },
    {
        "id": "dd46e49040b2c855",
        "type": "http request",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 500,
        "y": 640,
        "wires": [
            [
                "02cf92fb5a649eb2"
            ]
        ]
    },
    {
        "id": "4b68464aac34045b",
        "type": "subflow:f33b48a9db5775f9",
        "z": "7c27a8c8ec69277d",
        "g": "e59f934448fe6324",
        "name": "Configuration",
        "x": 930,
        "y": 80,
        "wires": []
    },
    {
        "id": "d8cdbaee723651d1",
        "type": "subflow:69fa40f5c518b9d9",
        "z": "7c27a8c8ec69277d",
        "g": "e59f934448fe6324",
        "name": "scheduleAV update",
        "x": 950,
        "y": 200,
        "wires": []
    },
    {
        "id": "4b51466b3b124479",
        "type": "function",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "GET all objects",
        "func": "let icalToScheduleConf = flow.get('f_icalToScheduleConf');\n\nreturn {\n    \"method\": \"GET\",\n    \"url\": \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/services/bacnet/local/objects\",\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" }\n};\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 680,
        "wires": [
            [
                "4eb11c8599185bf8"
            ]
        ]
    },
    {
        "id": "6d0aadf93bcb3dcb",
        "type": "inject",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "Send Request",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "x": 195,
        "y": 680,
        "wires": [
            [
                "4b51466b3b124479"
            ]
        ],
        "l": false
    },
    {
        "id": "4eb11c8599185bf8",
        "type": "http request",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "981e3c64757e1f1b",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 500,
        "y": 680,
        "wires": [
            [
                "4c598606ae5d455f"
            ]
        ]
    },
    {
        "id": "4c598606ae5d455f",
        "type": "debug",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "Objects",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 990,
        "y": 680,
        "wires": []
    },
    {
        "id": "49235db22d809404",
        "type": "subflow:748d34b69945229e",
        "z": "7c27a8c8ec69277d",
        "g": "717b28d528948e6a",
        "name": "",
        "x": 930,
        "y": 340,
        "wires": []
    },
    {
        "id": "50d907eb2f5616ca",
        "type": "link out",
        "z": "7c27a8c8ec69277d",
        "g": "e59f934448fe6324",
        "name": "configuration OUT",
        "mode": "link",
        "links": [
            "ad4e81c813c05d28"
        ],
        "x": 865,
        "y": 140,
        "wires": []
    },
    {
        "id": "ad4e81c813c05d28",
        "type": "link in",
        "z": "7c27a8c8ec69277d",
        "g": "717b28d528948e6a",
        "name": "ical server status IN",
        "links": [
            "50d907eb2f5616ca"
        ],
        "x": 245,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "8ec2a85ec2b17921",
        "type": "inject",
        "z": "7c27a8c8ec69277d",
        "g": "717b28d528948e6a",
        "name": "Send Request",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": "2",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "x": 245,
        "y": 400,
        "wires": [
            []
        ],
        "l": false
    },
    {
        "id": "a7a1f5b6391189e3",
        "type": "function",
        "z": "7c27a8c8ec69277d",
        "g": "717b28d528948e6a",
        "name": "GET all objects",
        "func": "let icalToScheduleConf = flow.get('f_icalToScheduleConf');\n\nreturn {\n    \"method\": \"GET\",\n    \"url\": \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/services/bacnet/local/objects\",\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" }\n};\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 400,
        "wires": [
            [
                "dde8974e1851971f"
            ]
        ]
    },
    {
        "id": "f46ec136defc086f",
        "type": "function",
        "z": "7c27a8c8ec69277d",
        "g": "717b28d528948e6a",
        "name": "valves",
        "func": "let rooms = flow.get('f_rooms');\nlet sche = msg.payload?.schedules || null;\nlet analogs = msg.payload?.[\"analog-values\"] || null;\n\nlet valves = [];\nlet schedules = {};\nlet analogValues = {}\n\nfor (let elem in sche) {\n    let schedule = sche[elem];\n\n    schedules[schedule[\"object-name\"]] = {\n        \"time-to-next-state\": schedule[\"time-to-next-state\"],\n        \"present-value\": schedule[\"present-value\"],\n    }\n}\n\n//node.warn(schedules);\n\nfor (let ana in analogs) {\n    let analog = analogs[ana];\n\n    let objectName = analog[\"object-name\"];\n    //node.warn(\"objectName : \" + objectName );\n    let bacnetObjectName = \"\";\n    if (objectName.includes(\"valveTemperature\")) bacnetObjectName = \"valveTemperature\";\n    else if (objectName.includes(\"valveSetpoint\")) bacnetObjectName = \"valveSetpoint\";\n    else if (objectName.includes(\"controllerSetpoint\")) bacnetObjectName = \"controllerSetpoint\";\n    else if (objectName.includes(\"valvePosition\")) bacnetObjectName = \"valvePosition\";\n    else continue;\n\n    let deviceType = \"\";\n    if (objectName.includes(\"usmb-valve\")) deviceType = \"usmb-valve\";\n    else if (objectName.includes(\"micropelt-mlr003\")) deviceType = \"micropelt-mlr003\";\n    else break;\n\n\n    let regex = new RegExp(`${deviceType}-(\\\\d+)-${bacnetObjectName}`);\n    let match = objectName.match(regex);\n    let deviceNum = match ? match[1] : null;\n    let deviceName = deviceType + '-' + match[1];\n\n    //node.warn('deviceNum :' + deviceNum );\n    //node.warn('deviceName :' + deviceName );\n\n    if (!analogValues[deviceName]) {\n        analogValues[deviceName] = {};\n        analogValues[deviceName].deviceNum = deviceNum;\n        analogValues[deviceName].deviceType = deviceType;\n    }\n    analogValues[deviceName][bacnetObjectName] = analog[\"present-value\"];\n}\n\n//node.warn(analogValues);\n\nfor (let room in rooms) {\n    if (rooms[room].control != \"controlledByConstant\") {\n        let deviceType = Object.keys(rooms[room].devices);\n        let deviceNums = rooms[room].devices[deviceType].deviceNums;\n        //node.warn(\"deviceType : \" + deviceType);\n\n        for (let i = 0; i < deviceNums.length; i++) {\n            let deviceName = deviceType + '-' + deviceNums[i];\n            let scheduleName = rooms[room].scheduleName;\n           // node.warn(\"scheduleName : \" + scheduleName);\n            let status = (analogValues[deviceName].valveSetpoint === analogValues[deviceName].controllerSetpoint) ? true : false;\n\n            let minutesNbr = schedules[scheduleName][\"time-to-next-state\"];\n            let timeToNextState = \"\";\n            if (minutesNbr == -1) {\n                //schedules[scheduleName][\"time-to-next-state\"] = \"Not yet scheduled\";\n                timeToNextState = \"Not yet scheduled\";\n\n            } else {\n\n                const days = Math.floor(minutesNbr / (24 * 60));\n                const hours = Math.floor((minutesNbr % (24 * 60)) / 60);\n                const minutes = minutesNbr % 60;\n\n                if (days == 0) {\n                    //schedules[scheduleName][\"time-to-next-state\"] = `${hours}h ${minutes}mins`;\n                    timeToNextState = `${hours}h ${minutes}mins`;\n\n                } else {\n                    //schedules[scheduleName][\"time-to-next-state\"] = `${days}d ${hours}h ${minutes}mins`;\n                    timeToNextState = `${days}d ${hours}h ${minutes}mins`;\n\n                }\n            }\n\n            if (analogValues[deviceName]) {\n                valves.push({\n                    \"status\": status,\n                    \"scheduleName\": scheduleName,\n                    \"deviceName\": deviceName,\n                    \"valveTemperature\": analogValues[deviceName].valveTemperature,\n                    \"valveSetpoint\": analogValues[deviceName].valveSetpoint,\n                    \"valvePosition\": analogValues[deviceName].valvePosition,\n                    \"ADE-Setpoint\": schedules[scheduleName][\"present-value\"],\n                    \"time-to-next-state\": timeToNextState\n                });\n\n            }\n        }\n    }\n}\n\nnode.warn(\"Updating onboard GTC...\");\n\nreturn {\n    payload: valves\n};\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 400,
        "wires": [
            [
                "230c902f8db1e63d"
            ]
        ]
    },
    {
        "id": "dde8974e1851971f",
        "type": "http request",
        "z": "7c27a8c8ec69277d",
        "g": "717b28d528948e6a",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "981e3c64757e1f1b",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 550,
        "y": 400,
        "wires": [
            [
                "f46ec136defc086f"
            ]
        ]
    },
    {
        "id": "230c902f8db1e63d",
        "type": "ui-table",
        "z": "7c27a8c8ec69277d",
        "g": "717b28d528948e6a",
        "group": "bb79fce18bf34dc3",
        "name": "Thermostatic valves",
        "label": "",
        "order": 1,
        "width": 0,
        "height": 0,
        "maxrows": 0,
        "passthru": false,
        "autocols": false,
        "showSearch": false,
        "deselect": true,
        "selectionType": "none",
        "columns": [
            {
                "title": "Status",
                "key": "status",
                "keyType": "key",
                "type": "tickcross",
                "width": "",
                "align": "center"
            },
            {
                "title": "Room",
                "key": "scheduleName",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "center"
            },
            {
                "title": "Valve",
                "key": "deviceName",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "center"
            },
            {
                "title": "Temperature",
                "key": "valveTemperature",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "center"
            },
            {
                "title": "Position",
                "key": "valvePosition",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "center"
            },
            {
                "title": "Setpoint",
                "key": "valveSetpoint",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "center"
            },
            {
                "title": "ADE Setpoint",
                "key": "ADE-Setpoint",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "center"
            },
            {
                "title": "Time to next setpoint",
                "key": "time-to-next-state",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "center"
            }
        ],
        "mobileBreakpoint": "sm",
        "mobileBreakpointType": "defaults",
        "action": "replace",
        "x": 940,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "4e6ebaf5965c80ed",
        "type": "function",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "List Special events",
        "func": "let icalToScheduleConf = flow.get('f_icalToScheduleConf');\n\nreturn {\n    \"method\": \"GET\",\n    \"url\": \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/services/bacnet/local/objects/schedules/0/special-events\",\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" }\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 720,
        "wires": [
            [
                "e1be88ea5ff19887"
            ]
        ]
    },
    {
        "id": "ea2f4af98df53c6f",
        "type": "inject",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 195,
        "y": 720,
        "wires": [
            [
                "4e6ebaf5965c80ed"
            ]
        ],
        "l": false
    },
    {
        "id": "e1be88ea5ff19887",
        "type": "http request",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 500,
        "y": 720,
        "wires": [
            [
                "d298eee68a586a0c"
            ]
        ]
    },
    {
        "id": "d298eee68a586a0c",
        "type": "debug",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "Schedules",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1000,
        "y": 720,
        "wires": []
    },
    {
        "id": "393d2de1a3dd4d28",
        "type": "function",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "Set weekly events",
        "func": "let icalToScheduleConf = flow.get('f_icalToScheduleConf');\n\nreturn {\n    \"method\": \"POST\",\n    \"url\": \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/services/bacnet/local/objects/schedules/0/weekly-schedule\",\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" },\n    \"payload\":\n    {\n        monday: {\n            transitions: {\n                \"1\": { time: \"14:00:00.00\", value: 7, key: \"1\" },\n                \"2\": { time: \"18:30:00.00\", value: null, key: \"2\" }\n\n            }\n        },\n        tuesday: { transitions: {} },\n        wednesday: { transitions: {} },\n        thursday: { transitions: {} },\n        friday: { transitions: {} },\n        saturday: { transitions: {} },\n        sunday: { transitions: {} }\n    }\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 800,
        "wires": [
            [
                "2fbfc9010c61fc0b"
            ]
        ]
    },
    {
        "id": "013c3b4d2ad370cb",
        "type": "inject",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 195,
        "y": 800,
        "wires": [
            [
                "393d2de1a3dd4d28"
            ]
        ],
        "l": false
    },
    {
        "id": "2fbfc9010c61fc0b",
        "type": "http request",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "HTTP",
        "method": "use",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 500,
        "y": 800,
        "wires": [
            [
                "e4d83857f1e66295"
            ]
        ]
    },
    {
        "id": "e4d83857f1e66295",
        "type": "debug",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "Schedules",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1010,
        "y": 800,
        "wires": []
    },
    {
        "id": "6f466eea47a546ea",
        "type": "function",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "List Weekly events",
        "func": "let icalToScheduleConf = flow.get('f_icalToScheduleConf');\n\nreturn {\n    \"method\": \"GET\",\n    \"url\": \"https://\" + icalToScheduleConf.controllerIPAddress + \"/api/rest/v2/services/bacnet/local/objects/schedules/0/weekly-schedule\",\n    \"headers\": { Authorization: icalToScheduleConf.httpAuthentication, \"Content-Type\": \"application/json\" }\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 760,
        "wires": [
            [
                "981fe7f22dccfc11"
            ]
        ]
    },
    {
        "id": "cead8873ee8b73e1",
        "type": "inject",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 195,
        "y": 760,
        "wires": [
            [
                "6f466eea47a546ea"
            ]
        ],
        "l": false
    },
    {
        "id": "981fe7f22dccfc11",
        "type": "http request",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "HTTP",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "ad66506e746a6eea",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 500,
        "y": 760,
        "wires": [
            [
                "1fa601afaa8cb01f"
            ]
        ]
    },
    {
        "id": "1fa601afaa8cb01f",
        "type": "debug",
        "z": "7c27a8c8ec69277d",
        "g": "cc921d23986230be",
        "name": "Schedules",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1000,
        "y": 760,
        "wires": []
    },
    {
        "id": "ad66506e746a6eea",
        "type": "tls-config",
        "name": "",
        "cert": "",
        "key": "",
        "ca": "",
        "certname": "",
        "keyname": "",
        "caname": "",
        "servername": "",
        "verifyservercert": false,
        "alpnprotocol": ""
    },
    {
        "id": "981e3c64757e1f1b",
        "type": "tls-config",
        "name": "",
        "cert": "",
        "key": "",
        "ca": "",
        "certname": "",
        "keyname": "",
        "caname": "",
        "servername": "",
        "verifyservercert": false,
        "alpnprotocol": ""
    },
    {
        "id": "bb79fce18bf34dc3",
        "type": "ui-group",
        "name": "Thermostatic valves",
        "page": "cd38f43643ab8e0a",
        "width": "8",
        "height": 1,
        "order": 1,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "cd38f43643ab8e0a",
        "type": "ui-page",
        "name": "Valves dashboard",
        "ui": "e09cfd48728aad39",
        "path": "/valves",
        "icon": "home",
        "layout": "grid",
        "theme": "1757f642506c7f22",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 2,
        "className": "",
        "visible": true,
        "disabled": false
    },
    {
        "id": "1757f642506c7f22",
        "type": "ui-theme",
        "name": "Default Theme",
        "colors": {
            "surface": "#ffffff",
            "primary": "#0094CE",
            "bgPage": "#eeeeee",
            "groupBg": "#ffffff",
            "groupOutline": "#cccccc"
        },
        "sizes": {
            "density": "default",
            "pagePadding": "12px",
            "groupGap": "12px",
            "groupBorderRadius": "4px",
            "widgetGap": "12px"
        }
    }
]